<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <title>Boletas de Rifa — rápido & fluido</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, interactive-widget=overlays-content">
  <!-- Performance -->
  <link rel="preconnect" href="https://docs.google.com" crossorigin>
  <link rel="preconnect" href="https://csv-proxy.jeisendigital.workers.dev" crossorigin>
  <style>
/* ====== BASE UI (ligero y veloz) ====== */
:root{
  --bg:#129a3a; --bg-deep:#0e7f30; --ink:#ffffff; --muted:#e5ffe8;
  --accent1:#00ffa9; --accent2:#3db7ff; --accent3:#ffb24d;
  --header-h:90px; --vv-top:0px; --extra-top:0px;
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%} html{overflow-anchor:none}
body{
  margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  color:var(--ink); background:var(--bg);
  -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  line-height:1.2;
  padding-top:calc(var(--header-h) + var(--vv-top) + var(--extra-top));
  overscroll-behavior-y:contain; touch-action:manipulation;
}
.top-veil{
  position:fixed; left:0; right:0; top:0; z-index:25; pointer-events:none;
  height:calc(var(--vv-top) + var(--extra-top) + var(--header-h) + 16px);
  background:linear-gradient(180deg,rgba(14,127,48,.94) 0%,rgba(14,127,48,.88) 40%,rgba(14,127,48,.72) 70%,rgba(14,127,48,0) 100%);
  -webkit-backdrop-filter:saturate(120%) blur(6px); backdrop-filter:saturate(120%) blur(6px);
  border-bottom:1px solid rgba(255,255,255,.12);
}
header{
  position:fixed; left:0; right:0; z-index:30; top:0 !important;
  display:flex;align-items:center;gap:10px;flex-wrap:wrap;
  padding:10px 14px; min-height:90px;
  background:linear-gradient(0deg,rgba(0,0,0,.18),rgba(0,0,0,.18)), var(--bg-deep);
  border-bottom:1px solid rgba(255,255,255,.12);
  box-shadow:0 10px 26px rgba(0,0,0,.35);
  transform:translateZ(0); -webkit-transform:translateZ(0); backface-visibility:hidden; contain:paint;
}
.brand{display:flex;align-items:center;gap:12px}
.brand img{height:56px;width:56px;object-fit:cover;border-radius:50%;
  border:2px solid rgba(255,255,255,.2);box-shadow:0 0 0 2px rgba(255,255,255,.18),0 0 22px rgba(0,0,0,.25)}
.brand h1{margin:0;font-weight:900;font-size:clamp(18px,3.2vw,24px);letter-spacing:.5px;
  background:linear-gradient(90deg,#fff,var(--accent2) 50%,var(--accent1) 90%);
  -webkit-background-clip:text;background-clip:text;color:transparent}
.search-bar{
  flex:1 1 320px;height:56px;border-radius:16px;border:1px solid rgba(255,255,255,.22);
  padding:0 14px;font-size:20px;line-height:56px;outline:none;background:#0f3c1e;color:#f6fff7;
  box-shadow:inset 0 0 0 1px rgba(255,255,255,.15),0 8px 20px rgba(0,0,0,.25);
  touch-action:manipulation;caret-color:#ffffff;-webkit-appearance:none;appearance:none;scroll-margin-top:14vh
}
.search-bar::placeholder{color:rgba(235,255,240,.8)}
.search-bar:focus{box-shadow:inset 0 0 0 2px var(--accent2),0 0 16px rgba(61,183,255,.45)}
.random-button{
  height:56px;border-radius:16px;padding:0 16px;font-weight:900;letter-spacing:.5px;border:none;cursor:pointer;color:#062017;
  background:linear-gradient(90deg,var(--accent1),#a9ffdf)
}
.contact-info{display:flex;flex-direction:row;align-items:center;gap:10px;margin-left:auto}
.contact-info p{margin:0;font-size:12px;color:#e5ffe8;font-weight:800;letter-spacing:.2px}

/* Result: cuando hay seleccionado/aleatorio, solo se muestra el elegido */
.search-result{
  position:fixed; top:calc(var(--vv-top) + var(--extra-top) + var(--header-h) + 12px);
  left:50%; transform:translateX(-50%); z-index:55;
  display:none; width:min(92vw,720px);
  pointer-events:auto; display:flex;flex-wrap:wrap;justify-content:center;gap:12px
}
body.search-has-text #raffles{ display:none !important; } /* << solo mostrar seleccionado */
#raffles{
  display:flex;flex-wrap:wrap;justify-content:center;gap:12px;
  margin:16px auto 28px;max-width:1240px;padding:0 10px 20vh
}

/* Tile */
.raffle{
  --size:clamp(92px,26vw,124px);
  width:var(--size);height:calc(var(--size) + 16px);
  border-radius:16px;display:flex;align-items:center;justify-content:center;
  position:relative;font-weight:900;color:#fff;
  background:
    radial-gradient(circle at 50% 28%, rgba(255,255,255,.10) 0 18%, transparent 19%),
    radial-gradient(circle at 37% 42%, rgba(255,255,255,.10) 0 18%, transparent 19%),
    radial-gradient(circle at 63% 42%, rgba(255,255,255,.10) 0 18%, transparent 19%),
    linear-gradient(145deg, transparent 0 62%, rgba(255,255,255,.10) 63%, transparent 64%),
    linear-gradient(160deg,#0b2b15,#0a2412 60%);
  box-shadow:inset 0 0 0 1px rgba(255,255,255,.10),0 10px 26px rgba(0,0,0,.35);
  outline:none;cursor:pointer;border:none;transform:translateZ(0)
}
.raffle span{font-size:clamp(38px,8.5vw,48px);line-height:1;text-shadow:0 2px 10px rgba(0,0,0,.45),0 0 18px rgba(255,255,255,.18)}
.raffle::before{
  content:"";position:absolute;inset:-1px;border-radius:inherit;padding:6px;
  background:conic-gradient(from 180deg at 50% 50%,var(--accent1),var(--accent2),var(--accent3),var(--accent1));
  -webkit-mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);
  -webkit-mask-composite:xor;mask-composite:exclude;opacity:.95
}
.raffle::after{content:"";position:absolute;inset:2px;border-radius:14px;background:radial-gradient(60% 60% at 50% 45%, rgba(255,255,255,.08), transparent 70%);z-index:0}
.large-raffle{--size:clamp(160px,52vw,200px);width:var(--size);height:calc(var(--size) + 18px)}
.large-raffle span{font-size:clamp(50px,12vw,70px)}

/* Mensajes y overlay */
.message{
  padding:14px 16px;background:rgba(255,255,255,.12);color:#fff;border:1px solid rgba(255,255,255,.45);
  border-radius:14px;width:min(92vw,420px);text-align:center;
  font-size:clamp(16px,4.8vw,22px);font-weight:900;display:none;
  position:fixed;top:calc(var(--vv-top) + var(--extra-top) + var(--header-h) + 10px);left:50%;transform:translateX(-50%);
  z-index:60;box-shadow:0 12px 30px rgba(0,0,0,.35)
}
.message.error{background:#ff3b30;border-color:#ffd0d0;color:#fff}
.loading-message{
  position:fixed;top:44%;left:50%;transform:translate(-50%,-50%);
  background:#0f3c1e;color:#eaffea;border:1px solid rgba(255,255,255,.35);
  border-radius:14px;padding:16px 18px;text-align:center;font-size:clamp(18px,5vw,24px);
  display:none;box-shadow:0 12px 30px rgba(0,0,0,.35);z-index:40
}
.ov{
  position:fixed; inset:0; background:rgba(0,0,0,.35);
  backdrop-filter:saturate(120%) blur(2px);
  z-index:9000; display:none; align-items:center; justify-content:center
}
.ov.show{display:flex}
.box{
  display:block; min-width:min(92vw,520px); max-width:92vw;
  background:#0f3c1e;color:#fff; border-radius:20px; border:1px solid rgba(255,255,255,.18);
  box-shadow:0 20px 60px rgba(0,0,0,.55); padding:20px 18px; text-align:center; transform-origin:center center
}
.q{margin:0 0 10px 0;font-size:clamp(18px,5vw,22px);font-weight:900}
.actions{display:flex;gap:10px;justify-content:center}
.btn.ok{font-weight:900;border:none;border-radius:14px;padding:12px 18px;cursor:pointer;background:linear-gradient(90deg,var(--accent1),#a9ffdf);color:#062017}
.btn.no{font-weight:900;border:none;border-radius:14px;padding:12px 18px;cursor:pointer;background:linear-gradient(90deg,#ff6b6b,#ffd0d0);color:#1a0606}

/* Revelado del número */
.raffle.revealed span{animation:revealPop .6s cubic-bezier(.2,.9,.2,1)}
@keyframes revealPop{0%{transform:scale(.9);filter:brightness(1.25);text-shadow:0 0 18px rgba(255,255,255,.55),0 0 30px rgba(0,255,169,.28)}55%{transform:scale(1.05)}100%{transform:scale(1);filter:none}}

@media(max-width:768px){
  header{gap:8px;padding:12px 10px}
  .contact-info{flex-direction:row;flex-wrap:wrap;justify-content:center}
  .search-bar,.random-button{width:100%}
  #raffles{gap:10px;margin-top:12px}
}
@media(prefers-reduced-motion:reduce){*,*::before,*::after{animation:none !important;transition:none !important}}
  </style>
</head>
<body>
  <div class="top-veil" aria-hidden="true"></div>

  <header>
    <div class="brand">
      <img id="logoImg" src="" alt="Logo" referrerpolicy="no-referrer">
      <h1 id="houseName">Rifas</h1>
    </div>
    <input id="search" class="search-bar" type="tel" inputmode="numeric" pattern="[0-9]*" maxlength="4" enterkeyhint="search" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Buscar # de boleta…">
    <button class="random-button" id="randomButton"># ALEATORIO</button>
    <div class="contact-info"><p id="phone"></p><p id="address"></p></div>
  </header>

  <div id="searchResult" class="search-result"></div>
  <div id="raffles" aria-live="polite"></div>

  <!-- Overlay + Modal -->
  <div id="ov" class="ov" aria-hidden="true">
    <div id="box" class="box" role="dialog" aria-modal="true">
      <p id="q" class="q"></p>
      <div class="actions">
        <button id="yes" class="btn ok" type="button">Sí</button>
        <button id="no" class="btn no" type="button">No</button>
      </div>
    </div>
  </div>

  <!-- Mensajes -->
  <div id="message" class="message">Boleta ocupada</div>
  <div id="loadingMessage" class="loading-message">Buscando número aleatorio...</div>

  <script>
/* =========================
   CONFIG + ORÍGENES
   ========================= */
const KEY = '1MyOkJrGpeY1ZXQVFq_srndALEh6Nzzir8sFSfu-0EVM';
const GID_RAFFLES = '1661037065';   // A: Número, B: Libre/Asignado
const GID_CONFIG  = '856149436';    // Config_Publica
const PROXY = 'https://csv-proxy.jeisendigital.workers.dev/?u=';

/* =========================
   RENDIMIENTO: caché local
   ========================= */
const CACHE_TTL_MS = 10 * 60 * 1000; // 10 min
const MAP_CACHE_KEY = 'raffle_map_v3';
const CONF_CACHE_KEY = 'raffle_conf_v1';

function saveMapCache(freeList){
  try{ localStorage.setItem(MAP_CACHE_KEY, JSON.stringify({ts:Date.now(), freeList})) }catch(_){}
}
function loadMapCache(){
  try{
    const raw = localStorage.getItem(MAP_CACHE_KEY);
    if(!raw) return null;
    const {ts, freeList} = JSON.parse(raw);
    if(!Array.isArray(freeList)) return null;
    if(Date.now() - ts > CACHE_TTL_MS) return {freeList, stale:true};
    return {freeList, stale:false};
  }catch(_){ return null; }
}
function saveConfCache(conf){
  try{ localStorage.setItem(CONF_CACHE_KEY, JSON.stringify({ts:Date.now(), conf})) }catch(_){}
}
function loadConfCache(){
  try{
    const raw = localStorage.getItem(CONF_CACHE_KEY);
    if(!raw) return null;
    const {ts, conf} = JSON.parse(raw);
    if(!conf) return null;
    return {conf, stale:(Date.now()-ts) > CACHE_TTL_MS};
  }catch(_){ return null; }
}

/* =========================
   FETCH optimizado (parallel + timeout)
   ========================= */
const csvUrls = (gid) => {
  const ts = Date.now();
  return [
    `https://docs.google.com/spreadsheets/d/${KEY}/export?format=csv&gid=${gid}&_=${ts}`,
    `https://docs.google.com/spreadsheets/d/${KEY}/gviz/tq?tqx=out:csv&gid=${gid}&_=${ts}`
  ];
};
function fetchWithTimeout(url, timeout=6000){
  const ctrl = new AbortController();
  const to = setTimeout(()=>ctrl.abort(), timeout);
  return fetch(PROXY + encodeURIComponent(url), {signal:ctrl.signal, cache:'no-store', credentials:'omit'})
    .then(r=>{clearTimeout(to); if(!r.ok) throw new Error('HTTP '+r.status); return r.text()});
}
async function fetchCsvAny(gid, timeoutEach=6000){
  const urls = csvUrls(gid);
  const attempts = urls.map(u => fetchWithTimeout(u, timeoutEach).then(txt=>{
    if(txt && !txt.trimStart().startsWith('<')) return txt;
    throw new Error('Respuesta inválida');
  }));
  return new Promise((resolve, reject)=>{
    let rej=0, reason=null;
    attempts.forEach(p => p.then(resolve).catch(e=>{reason=e; if(++rej===attempts.length) reject(reason)}));
  });
}

/* =========================
   Estado global liviano
   ========================= */
let ALL = {};             // { "0000": "libre"/"ocupado" }
let DAILY = [];           // hasta 240 render inmediato
let SEARCH_INPUT = null;
let GRID_TIMER = null;
let MAP_TIMER = null;
let MODAL_OPEN = false;
let DAY_MARK = null;

/* =========================
   Utils
   ========================= */
const pad4 = n => String(n).replace(/\D/g,'').slice(0,4).padStart(4,'0');
const todayKey = () => new Date().toISOString().slice(0,10);
function randInt(maxExclusive){
  if (crypto?.getRandomValues){ const b = new Uint32Array(1); crypto.getRandomValues(b); return b[0] % maxExclusive; }
  return Math.floor(Math.random()*maxExclusive);
}
function msg(text, error=false){
  const el = document.getElementById('message'); if(!el) return;
  el.textContent = text || ''; el.classList.toggle('error', !!error); el.style.display = 'block';
  clearTimeout(msg._t); msg._t = setTimeout(()=>{ el.style.display = 'none'; }, error ? 2000 : 1000);
}
function hideMsg(){ const el = document.getElementById('message'); if(!el) return; clearTimeout(msg._t); el.style.display='none'; }
function parseCSV(text){
  if (text.trimStart().startsWith('<')) return [];
  const rows=[]; let i=0,cur='',inQ=false; const push=()=>{ rows[rows.length-1].push(cur); cur='' };
  rows.push([]);
  while(i<text.length){
    const c=text[i];
    if(inQ){ if(c==='"'){ if(text[i+1]==='"'){cur+='"';i++} else inQ=false } else cur+=c; }
    else{ if(c==='"'){ inQ=true } else if(c===','){ push() } else if(c==='\n'){ push(); rows.push([]) } else if(c!=='\r'){ cur+=c } }
    i++;
  }
  push(); return rows.filter(r => r.some(x=>String(x).trim()!==''));
}
function makeBaseMap(){ const map={}; for(let i=0;i<10000;i++){ map[String(i).padStart(4,'0')]='ocupado' } return map }
function normStatusAB(s){ const t=String(s??'').trim().toLowerCase(); return t==='libre' ? 'libre' : 'ocupado' }
function extractColombiaDigits(raw){
  const chunks=(String(raw||'').match(/\d+/g)||[]); let d=chunks.join(''); d=d.replace(/^00/,'');
  const m=d.match(/57(3\d{9})/); if(m) return '57'+m[1];
  const m2=d.match(/(?:^|[^0-9])(3\d{9})(?:[^0-9]|$)/); if(m2) return '57'+m2[1];
  const m3=d.match(/0(3\d{9})/); if(m3) return '57'+m3[1];
  if(d.startsWith('57') && d.length>=12) return d.slice(0,12);
  return null;
}

/* =========================
   UI helpers
   ========================= */
function closeBox(withScale){
  const ov=document.getElementById('ov'), box=document.getElementById('box');
  if(!ov||!box) return;
  const a1 = box.animate(withScale?[{transform:'scale(1)',opacity:1},{transform:'scale(.94)',opacity:0}]:[{opacity:1},{opacity:0}],{duration:180,easing:'ease-in',fill:'forwards'});
  const a2 = ov.animate([{backgroundColor:'rgba(0,0,0,0.35)'},{backgroundColor:'rgba(0,0,0,0)'}],{duration:180,fill:'forwards'});
  Promise.all([a1.finished,a2.finished]).catch(()=>{}).finally(()=>{
    MODAL_OPEN=false; ov.classList.remove('show'); ov.setAttribute('aria-hidden','true');
    box.style.opacity='1'; box.style.transform='none'; ov.style.backgroundColor='rgba(0,0,0,0.35)';
  });
}
function openWA(number){
  const tel = window.__CONFIG_PHONE_DIGITS || '573206413635';
  const message = "Hola, estoy interesado en separar este número: " + number;
  const url = "https://wa.me/" + tel + "?text=" + encodeURIComponent(message);
  const w = window.open(url, '_blank'); if (!w){ location.href = url; }
}
function makeTile(num, large){
  const el = document.createElement('div');
  el.className = 'raffle' + (large ? ' large-raffle' : '');
  el.innerHTML = `<span>${num}</span>`;
  el.addEventListener('pointerdown', (ev)=>{ el._lastPt = {x:ev.clientX, y:ev.clientY}; }, {passive:true});
  el.addEventListener('touchstart', (ev)=>{ const t=ev.touches&&ev.touches[0]; if(t) el._lastPt={x:t.clientX,y:t.clientY}; }, {passive:true});
  el.addEventListener('click', (ev)=> onTileTap(el, num, el._lastPt || {x:ev.clientX, y:ev.clientY}), {passive:true});
  return el;
}
function renderGrid(){
  const wrap=document.getElementById('raffles'); if(!wrap) return;
  if(document.body.classList.contains('search-has-text') || MODAL_OPEN) return;
  wrap.innerHTML='';
  const frag = document.createDocumentFragment();
  for(const n of DAILY){ frag.appendChild(makeTile(n,false)); }
  wrap.appendChild(frag);
}
function renderSearchOne(num){
  const layer=document.getElementById('searchResult');
  layer.style.display='none'; layer.innerHTML=''; if(!num) return;
  const t=makeTile(num,true); layer.appendChild(t); layer.style.display='flex';
  requestAnimationFrame(()=> t.classList.add('revealed'));
}
function clearSearchLayer(){ const layer=document.getElementById('searchResult'); layer.style.display='none'; layer.innerHTML='' }

/* =========================
   Config pública (rápida con caché)
   ========================= */
async function loadConfigFast(){
  const cached = loadConfCache();
  if (cached?.conf){ applyConfig(cached.conf); }
  try{
    const txt = await fetchCsvAny(GID_CONFIG, 5000);
    const rows = parseCSV(txt);
    if(rows.length>=2){
      const conf = readConf(rows);
      applyConfig(conf);
      saveConfCache(conf);
    }
  }catch(_){ /* usar caché si existe */ }
}
function readConf(rows){
  const head=rows[0], data=rows[1];
  const hIdx=(name)=> head.findIndex(h => String(h).trim().toLowerCase()===name.toLowerCase());
  return {
    name: data[hIdx('Nombre_APP')] || data[hIdx('Nombre_De_La_Rifa')] || 'Rifas',
    phoneRaw: data[hIdx('Telefonos')] || '',
    address: data[hIdx('Direccion')] || '',
    logo: data[hIdx('Logo')] || ''
  };
}
function applyConfig({name,phoneRaw,address,logo}){
  document.getElementById('houseName').textContent = String(name||'').trim();
  document.getElementById('phone').textContent = phoneRaw ? ('Tel: ' + phoneRaw) : '';
  document.getElementById('address').textContent = address ? ('Dir: ' + address) : '';
  document.getElementById('logoImg').src = String(logo||'').trim();
  window.__CONFIG_PHONE = phoneRaw || '';
  window.__CONFIG_PHONE_DIGITS = extractColombiaDigits(phoneRaw) || '573206413635';
}

/* =========================
   Mapa rápido (caché primero)
   ========================= */
function setAllFromFreeList(freeList){
  const map = makeBaseMap();
  for(const n of freeList){ map[n] = 'libre'; }
  ALL = map;
}
function sampleDailyFromFreeList(freeList, target=240){
  const L = freeList.length;
  if(L<=target) return [...freeList];
  const out = freeList.slice(0, target);
  for(let i=target;i<L;i++){
    const j = randInt(i+1);
    if(j<target) out[j] = freeList[i];
  }
  return out;
}
function persistDaily(){ const key='daily_'+todayKey(); try{ localStorage.setItem(key, JSON.stringify(DAILY||[])) }catch(_){ } }
function loadDailyFromCache(){
  const key='daily_'+todayKey();
  try{
    const cached = JSON.parse(localStorage.getItem(key)||'[]');
    if(Array.isArray(cached)&&cached.length){
      DAILY = cached.filter(n => ALL[n]==='libre');
      persistDaily(); return DAILY.length>0;
    }
  }catch(_){}
  return false;
}
function pickDaily(force=false){
  if(!force && loadDailyFromCache()) return;
  const libres = Object.keys(ALL||{}).filter(k=>ALL[k]==='libre');
  DAILY = sampleDailyFromFreeList(libres, 240);
  persistDaily();
}

/* =========================
   Sincronización remota
   ========================= */
async function syncMapFast(){
  try{
    const txt = await fetchCsvAny(GID_RAFFLES, 6000);
    const rows = parseCSV(txt);
    if(rows.length < 2) return;
    const freeList=[];
    for(let i=1;i<rows.length;i++){
      const r=rows[i]||[]; const a=(r[0]??'').toString().trim(); const b=(r[1]??'').toString().trim();
      if(!a) continue; let digits=a.replace(/\D/g,''); if(!digits) continue;
      if(digits.length>4) digits=digits.slice(0,4);
      const num=digits.padStart(4,'0');
      if (normStatusAB(b)==='libre') freeList.push(num);
    }
    saveMapCache(freeList);
    setAllFromFreeList(freeList);
    const before=DAILY.length;
    DAILY = DAILY.filter(n=>ALL[n]==='libre');
    if(DAILY.length===0){ pickDaily(true); }
    if(DAILY.length!==before){ renderGrid(); }
  }catch(_){ /* Silencio: ya hay caché/placeholder */ }
}

/* =========================
   Búsqueda
   ========================= */
async function rerenderSearch(){
  const layer=document.getElementById('searchResult'); hideMsg();
  const raw=(SEARCH_INPUT.value||'').replace(/\D/g,'').slice(0,4);
  if(SEARCH_INPUT.value!==raw) SEARCH_INPUT.value=raw;
  layer.style.display='none'; layer.innerHTML='';
  if(raw.length===0){ document.body.classList.remove('search-has-text'); return; }
  document.body.classList.add('search-has-text'); // oculta grid
  const padded=pad4(raw); const st=ALL[padded]||'ocupado';
  if(st==='libre'){ hideMsg(); renderSearchOne(padded); } else { clearSearchLayer(); msg('Boleta ocupada', true); }
}

/* =========================
   EFECTOS (on-demand)
   ========================= */
function overlayCanvas(container){
  if(!container) return null;
  const cs=getComputedStyle(container);
  if(cs.position==='static') container.style.position='relative';
  const rect=container.getBoundingClientRect();
  const dpr=Math.min(window.devicePixelRatio||1,2);
  const c=document.createElement('canvas'); const w=Math.max(1,Math.floor(rect.width*dpr)); const h=Math.max(1,Math.floor(rect.height*dpr));
  c.width=w; c.height=h; c.style.width=rect.width+'px'; c.style.height=rect.height+'px';
  c.style.position='absolute'; c.style.inset='0'; c.style.pointerEvents='none'; c.style.zIndex='5';
  container.appendChild(c); const ctx=c.getContext('2d');
  return {c,ctx,dpr,w,h,cleanup:()=>c.remove()};
}
function fullscreenCanvas(parent){
  const dpr=Math.min(window.devicePixelRatio||1,2);
  const c=document.createElement('canvas'); const w=Math.max(1,Math.floor(window.innerWidth*dpr)); const h=Math.max(1,Math.floor(window.innerHeight*dpr));
  c.width=w; c.height=h; c.style.width='100%'; c.style.height='100%';
  c.style.position='absolute'; c.style.inset='0'; c.style.pointerEvents='none'; c.style.zIndex='1';
  parent.appendChild(c); const ctx=c.getContext('2d');
  return {c,ctx,dpr,w,h,cleanup:()=>c.remove()};
}
function animateMs(duration, draw){
  return new Promise(res=>{
    const s=performance.now(); let last=s, id=0;
    function loop(t){ const e=t-s; const dt=Math.min(64,t-last)/1000; last=t; const p=Math.min(1,e/duration); draw(p,dt,e); if(e<duration){ id=requestAnimationFrame(loop) } else { cancelAnimationFrame(id); res(); } }
    id=requestAnimationFrame(loop);
  });
}
const easeOutCubic=x=>1-Math.pow(1-x,3);
const rgba=(r,g,b,a)=>`rgba(${r},${g},${b},${a})`;

/* Agua real + chispas (rápida: 1.2s) */
function playWaterRipple(container, duration=1200, center){
  if(!container) return Promise.resolve();
  if(matchMedia('(prefers-reduced-motion: reduce)').matches) return Promise.resolve();
  const oc=overlayCanvas(container); if(!oc) return Promise.resolve();
  const {ctx,w,h,dpr,cleanup}=oc;
  const cx=center?.x ?? (w/2), cy=center?.y ?? (h/2);
  const sparkCols=[[255,212,77],[0,255,169]];
  const SPN=Math.floor(14*Math.min(1.5,(w*h)/60000));
  const sparks=[];
  for(let i=0;i<SPN;i++){
    const ang=Math.random()*Math.PI*2, sp=(120+Math.random()*160)*dpr;
    sparks.push({x:cx,y:cy,vx:Math.cos(ang)*sp,vy:Math.sin(ang)*sp-70*dpr,r:(1+Math.random()*1.8)*dpr,life:0,max:0.5+Math.random()*0.45,col:sparkCols[(Math.random()*sparkCols.length)|0]});
  }
  const maxR=Math.hypot(w,h)*0.55; const rings=[{d:0},{d:110},{d:220}];
  function ring(R,th,a){
    if(R<=0||th<=0||a<=0)return;
    const inner=Math.max(0.0001,R-th), outer=R+th;
    const g=ctx.createRadialGradient(cx,cy,inner,cx,cy,outer);
    g.addColorStop(0.0,'rgba(0,0,0,0)');
    g.addColorStop(0.18,rgba(0,0,0,0.22*a));
    g.addColorStop(0.45,rgba(255,255,255,0.50*a));
    g.addColorStop(0.62,rgba(0,255,169,0.58*a));
    g.addColorStop(0.84,rgba(61,183,255,0.30*a));
    g.addColorStop(1.0,'rgba(0,0,0,0)');
    ctx.fillStyle=g; ctx.fillRect(0,0,w,h);
    ctx.save(); ctx.lineWidth=Math.max(0.8,2.5*dpr*(1-R/maxR)); ctx.strokeStyle=rgba(255,255,255,0.3*a);
    const arcLen=Math.PI*0.5, rot=-Math.PI/6; ctx.beginPath(); ctx.arc(cx,cy,R,rot,rot+arcLen); ctx.stroke(); ctx.restore();
  }
  return animateMs(duration,(p,dt,ms)=>{
    ctx.clearRect(0,0,w,h);
    const dimA=0.22*easeOutCubic(Math.min(1,ms/180)); ctx.fillStyle=rgba(0,0,0,dimA); ctx.fillRect(0,0,w,h);
    for(const r of rings){
      const t=ms-r.d; if(t<0) continue;
      const pr=Math.min(1,t/(duration-r.d+1)); const amp=(1-pr)*0.95; const R=pr*maxR; const th=Math.max(1.2*dpr, 9*dpr*(1-pr));
      ring(R,th,amp);
    }
    ctx.globalCompositeOperation='lighter';
    for(const s of sparks){
      s.life+=dt; s.vx*=(1-0.55*dt); s.vy*=(1-0.55*dt); s.vy+=200*dt*dpr*0.25; s.x+=s.vx*dt; s.y+=s.vy*dt;
      const a=Math.max(0,1-(s.life/s.max)); if(a<=0) continue;
      ctx.beginPath(); ctx.fillStyle=rgba(s.col[0],s.col[1],s.col[2],0.9*a); ctx.arc(s.x,s.y,s.r,0,Math.PI*2); ctx.fill();
      if(Math.random()<0.08){ ctx.beginPath(); ctx.fillStyle=rgba(255,255,255,0.55*a); ctx.arc(s.x,s.y,s.r*0.5,0,Math.PI*2); ctx.fill(); }
    }
    ctx.globalCompositeOperation='source-over';
  }).then(cleanup);
}

/* Estela brillante (cometa) del tile al modal (muy fluida: 480ms) */
async function drawTrailFromTileToBox(tile, box, ov, duration=480){
  if(matchMedia('(prefers-reduced-motion: reduce)').matches) return;
  const fs=fullscreenCanvas(ov); if(!fs) return;
  const {ctx,dpr,cleanup}=fs;
  const tr=tile.getBoundingClientRect(), br=box.getBoundingClientRect();
  const sx=(tr.left+tr.width/2)*dpr, sy=(tr.top+tr.height/2)*dpr;
  const ex=(br.left+br.width/2)*dpr, ey=(br.top+br.height/2)*dpr;
  const ctrl={x:(sx+ex)/2, y:Math.min(sy,ey)-100*dpr};
  const sparks=[];
  function addSpark(px,py){ sparks.push({x:px,y:py,vx:(Math.random()-0.5)*100*dpr,vy:(Math.random()-0.8)*140*dpr,life:0,max:0.22+Math.random()*0.18,r:(0.7+Math.random()*1.4)*dpr,col: (Math.random()<0.5 ? [255,212,77] : [0,255,169])}); }
  await animateMs(duration,(p,dt)=>{
    const w=window.innerWidth*dpr, h=window.innerHeight*dpr;
    ctx.clearRect(0,0,w,h);
    const t=p; // más directo = sensación veloz
    const x=(1-t)*(1-t)*sx + 2*(1-t)*t*ctrl.x + t*t*ex;
    const y=(1-t)*(1-t)*sy + 2*(1-t)*t*ctrl.y + t*t*ey;
    const base=Math.max(1.5*dpr, 8*dpr*(1-p));
    const grd=ctx.createLinearGradient(x,y,sx,sy);
    grd.addColorStop(0,'rgba(255,255,255,0.85)');
    grd.addColorStop(0.25,'rgba(255,212,77,0.7)');
    grd.addColorStop(1,'rgba(0,255,169,0.0)');
    ctx.save(); ctx.lineCap='round'; ctx.lineJoin='round'; ctx.shadowBlur=16*dpr; ctx.shadowColor='rgba(255,212,77,0.5)';
    ctx.strokeStyle=grd; ctx.lineWidth=base; ctx.beginPath(); ctx.moveTo(sx,sy); ctx.quadraticCurveTo(ctrl.x,ctrl.y,x,y); ctx.stroke();
    ctx.shadowBlur=22*dpr; ctx.fillStyle='rgba(255,255,255,0.9)'; ctx.beginPath(); ctx.arc(x,y,base*0.36,0,Math.PI*2); ctx.fill();
    ctx.shadowColor='rgba(0,255,169,0.5)'; ctx.strokeStyle='rgba(0,255,169,0.4)'; ctx.lineWidth=base*0.5;
    ctx.beginPath(); ctx.moveTo(sx,sy); ctx.quadraticCurveTo(ctrl.x,ctrl.y,x,y); ctx.stroke(); ctx.restore();
    addSpark(x,y);
    ctx.globalCompositeOperation='lighter';
    for(let i=sparks.length-1;i>=0;i--){
      const s=sparks[i]; s.life+=dt; s.vx*=(1-0.5*dt); s.vy+=180*dt*dpr*0.3; s.x+=s.vx*dt; s.y+=s.vy*dt;
      const a=Math.max(0,1-s.life/s.max); if(a<=0){sparks.splice(i,1); continue;}
      ctx.beginPath(); ctx.fillStyle=rgba(s.col[0],s.col[1],s.col[2],0.9*a); ctx.arc(s.x,s.y,s.r,0,Math.PI*2); ctx.fill();
    }
    ctx.globalCompositeOperation='source-over';
  });
  cleanup();
}

/* Modal que “salta” desde la boleta con estela, muy ágil */
function showChoiceFromTile(tile, n){
  const ov=document.getElementById('ov'), box=document.getElementById('box');
  const yes=document.getElementById('yes'), no=document.getElementById('no'), q=document.getElementById('q');
  if(!ov||!box||!yes||!no||!q) return;
  MODAL_OPEN=true; q.textContent="¿Quieres separar este número? " + n;
  ov.classList.add('show'); ov.setAttribute('aria-hidden','false');
  box.style.opacity='0'; box.style.transform='translate(0,0) scale(1)'; box.style.willChange='transform,opacity';
  requestAnimationFrame(async ()=>{
    const tr=tile.getBoundingClientRect(), br=box.getBoundingClientRect();
    const tx=tr.left+tr.width/2, ty=tr.top+tr.height/2, bx=br.left+br.width/2, by=br.top+br.height/2;
    const dx=tx-bx, dy=ty-by;
    drawTrailFromTileToBox(tile,box,ov,480).catch(()=>{});
    ov.animate([{backgroundColor:'rgba(0,0,0,0)'},{backgroundColor:'rgba(0,0,0,0.35)'}],{duration:220,easing:'ease-out',fill:'forwards'});
    const kf=[{transform:`translate(${dx}px,${dy}px) scale(0.26)`,opacity:0},
              {transform:`translate(${dx*0.10}px,${dy*0.10}px) scale(1.06)`,opacity:1,offset:0.66},
              {transform:'translate(0,0) scale(1)',opacity:1}];
    const a=box.animate(kf,{duration:520,easing:'cubic-bezier(.2,1,.2,1)',fill:'forwards'}); // más “spring”
    a.onfinish=()=>{box.style.opacity='1'; box.style.transform='none'; box.style.willChange='auto';};
  });
  yes.onclick=(e)=>{ e.preventDefault(); e.stopPropagation(); closeBox(true); openWA(n); };
  no.onclick =(e)=>{ e.preventDefault(); e.stopPropagation(); closeBox(false); };
  ov.onclick =()=> closeBox(false);
  box.onclick=(e)=> e.stopPropagation();
}

/* Tap de boleta: ahora conectamos ANTES de que termine el agua (overlap) */
function onTileTap(el, num, pt){
  if(!el || el.dataset.busy==='1') return;
  el.dataset.busy='1'; hideMsg();
  const rect=el.getBoundingClientRect(); const dpr=Math.min(window.devicePixelRatio||1,2);
  const cx=((pt?.x ?? (rect.left+rect.width/2)) - rect.left)*dpr;
  const cy=((pt?.y ?? (rect.top+rect.height/2))  - rect.top )*dpr;

  const rippleDur = 1200;       // efecto agua rápido
  const connectAt  = 680;       // abrimos modal antes de terminar el agua -> sensación continua

  // Arranca ondas
  const ripple = playWaterRipple(el, rippleDur, {x:cx,y:cy})
    .finally(()=>{ el.dataset.busy=''; });

  // Conecta con el modal de forma fluida
  setTimeout(()=>{ showChoiceFromTile(el, num); }, connectAt);
}

/* =========================
   INIT ultrarrápido
   ========================= */
document.addEventListener('DOMContentLoaded', async ()=>{
  function updateHeaderPadding(){ const hEl=document.querySelector('header'); if(!hEl) return; const h=Math.max(70,Math.round(hEl.getBoundingClientRect().height)); document.documentElement.style.setProperty('--header-h', h + 'px'); }
  function applyViewportOffset(){ let top=0; if(window.visualViewport){ top=Math.max(0,Math.round(window.visualViewport.offsetTop||0)); } document.documentElement.style.setProperty('--vv-top', top + 'px'); updateHeaderPadding(); }
  updateHeaderPadding(); applyViewportOffset();
  if(window.visualViewport){
    visualViewport.addEventListener('resize',()=>requestAnimationFrame(applyViewportOffset));
    visualViewport.addEventListener('scroll',()=>requestAnimationFrame(applyViewportOffset));
  }
  window.addEventListener('resize',()=>requestAnimationFrame(applyViewportOffset),{passive:true});

  // Inputs
  const SEARCH_INPUT_EL=document.getElementById('search'); SEARCH_INPUT=SEARCH_INPUT_EL;
  function instantFocus(e){
    if(document.activeElement!==SEARCH_INPUT){ e.preventDefault(); SEARCH_INPUT.focus({preventScroll:true});
      setTimeout(()=>{ try{ const len=SEARCH_INPUT.value.length; SEARCH_INPUT.setSelectionRange(len,len);}catch(_){ }},0); }
  }
  SEARCH_INPUT.addEventListener('pointerdown',instantFocus,{passive:false});
  SEARCH_INPUT.addEventListener('touchstart',instantFocus,{passive:false});
  SEARCH_INPUT.addEventListener('click',()=>{ if(document.activeElement!==SEARCH_INPUT) SEARCH_INPUT.focus({preventScroll:true}); },{passive:true});
  SEARCH_INPUT.addEventListener('input',()=>{ rerenderSearch(); });
  SEARCH_INPUT.addEventListener('blur',()=>{ if(!MODAL_OPEN && SEARCH_INPUT.value.trim().length===0){ document.body.classList.remove('search-has-text'); clearSearchLayer(); } });

  // Botón ALEATORIO — ahora oculta el grid y solo muestra el elegido
  const randomBtn=document.getElementById('randomButton');
  randomBtn.addEventListener('click', async ()=>{
    if(randomBtn.dataset.busy==='1') return; randomBtn.dataset.busy='1';
    hideMsg();

    const layer=document.getElementById('searchResult');
    layer.style.display='none'; layer.innerHTML='';

    // asegurar que el grid se oculte
    document.body.classList.add('search-has-text');

    // preparar datos
    if(!ALL || !Object.keys(ALL).length){
      const c=loadMapCache(); if(c?.freeList){ setAllFromFreeList(c.freeList); }
      else { await syncMapFast(); }
    }
    const libres=Object.keys(ALL||{}).filter(k=>ALL[k]==='libre');
    const chosen = libres.length ? libres[randInt(libres.length)] : String(randInt(10000)).padStart(4,'0');

    // Efecto compacto sorpresa (1s) y luego mostrar solo el elegido
    const placeholder=document.createElement('div'); placeholder.className='raffle large-raffle'; layer.appendChild(placeholder); layer.style.display='flex';

    await (async function playMagicBurst(container, duration=1000){
      if(!container || matchMedia('(prefers-reduced-motion: reduce)').matches) return;
      const oc=overlayCanvas(container); if(!oc) return;
      const {ctx,w,h,dpr,cleanup}=oc; const cx=w/2, cy=h/2;
      const colors=[[255,212,77],[0,255,169],[61,183,255],[255,255,255]];
      const N=Math.floor(Math.min(80,50+(w*h)/60000)); const parts=[];
      for(let i=0;i<N;i++){ const ang=Math.random()*Math.PI*2, sp=(80+Math.random()*180)*dpr, r=(1.3+Math.random()*2)*dpr, col=colors[(Math.random()*colors.length)|0]; parts.push({x:cx,y:cy,vx:Math.cos(ang)*sp,vy:Math.sin(ang)*sp,life:0,max:0.7+Math.random()*0.4,r,col}); }
      ctx.globalCompositeOperation='lighter';
      await animateMs(duration,(p,dt)=>{
        ctx.clearRect(0,0,w,h);
        const ringR=(Math.max(w,h)*0.46)*Math.sin(p*Math.PI); const aR=(1-p)*0.85;
        ctx.lineWidth=Math.max(1,4.5*dpr*(1-p)); ctx.strokeStyle=rgba(255,212,77,aR); ctx.beginPath(); ctx.arc(cx,cy,Math.max(0,ringR*0.6),0,Math.PI*2); ctx.stroke();
        ctx.strokeStyle=rgba(0,255,169,aR*0.85); ctx.beginPath(); ctx.arc(cx,cy,Math.max(0,ringR*0.42),0,Math.PI*2); ctx.stroke();
        for(const pt of parts){
          pt.life+=dt; pt.vx*=(1-0.8*dt); pt.vy*=(1-0.8*dt); pt.vy+=240*dt*dpr*0.25; pt.x+=pt.vx*dt; pt.y+=pt.vy*dt;
          const a=Math.max(0,1-(pt.life/pt.max)); if(a<=0) continue;
          ctx.beginPath(); ctx.fillStyle=rgba(pt.col[0],pt.col[1],pt.col[2],a); ctx.arc(pt.x,pt.y,pt.r,0,Math.PI*2); ctx.fill();
        }
      });
      cleanup();
    })(placeholder, 1000);

    const st=ALL[chosen]||'ocupado'; SEARCH_INPUT.value=String(parseInt(chosen,10));
    layer.innerHTML=''; // limpiar placeholder
    if(st==='libre'){ renderSearchOne(chosen); } else { clearSearchLayer(); msg('Boleta ocupada', true); }
    randomBtn.dataset.busy='';
  },{passive:true});

  // ARRANQUE EXPRESS
  DAY_MARK=todayKey();
  await loadConfigFast();
  const mcache=loadMapCache();
  if(mcache?.freeList){
    setAllFromFreeList(mcache.freeList);
    pickDaily(true);
    renderGrid();
    if(mcache.stale){ (window.requestIdleCallback? requestIdleCallback(syncMapFast): setTimeout(syncMapFast,0)); }
    else setTimeout(syncMapFast, 1500);
  }else{
    const wrap=document.getElementById('raffles');
    const frag=document.createDocumentFragment();
    for(let i=0;i<24;i++){ const s=document.createElement('div'); s.className='raffle'; s.innerHTML='<span>----</span>'; frag.appendChild(s); }
    wrap.appendChild(frag);
    await syncMapFast();
    pickDaily(true);
    renderGrid();
  }

  // Refrescos suaves
  GRID_TIMER=setInterval(()=>renderGrid(), 20000);
  MAP_TIMER=setInterval(async ()=>{
    const nowKey=todayKey();
    if(nowKey!==DAY_MARK){ DAY_MARK=nowKey; await syncMapFast(); DAILY=[]; pickDaily(true); renderGrid(); return; }
    const before=DAILY.length; await syncMapFast(); if(DAILY.length!==before){ renderGrid(); }
  }, 20000);
});
  </script>
</body>
</html>
