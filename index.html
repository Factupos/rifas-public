<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Boletas de Rifa</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, interactive-widget=overlays-content">
    <link rel="icon" href="data:,">
    <style>
:root{--bg:#129a3a;--bg-deep:#0e7f30;--ink:#ffffff;--muted:#e5ffe8;--a1:#00ffa9;--a2:#3db7ff;--a3:#ffb24d;--header-h:90px}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%}
body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--ink);background:var(--bg);line-height:1.2;padding-top:calc(var(--header-h)+10px);overscroll-behavior-y:contain;touch-action:manipulation}
header{position:fixed;left:0;right:0;top:10px;z-index:30;display:flex;align-items:center;gap:10px;padding:10px 14px;min-height:90px;background:linear-gradient(0deg,rgba(0,0,0,.18),rgba(0,0,0,.18)),var(--bg-deep);border-bottom:1px solid rgba(255,255,255,.12);box-shadow:0 10px 26px rgba(0,0,0,.35)}
header div{display:flex;align-items:center;gap:12px}
#logo{height:56px;width:56px;object-fit:cover;border-radius:50%;border:2px solid rgba(255,255,255,.2);box-shadow:0 0 0 2px rgba(255,255,255,.18),0 0 22px rgba(0,0,0,.25)}
#title{margin:0;font-weight:900;font-size:clamp(18px,3.2vw,24px);letter-spacing:.5px;background:linear-gradient(90deg,#fff,var(--a2) 50%,var(--a1) 90%);-webkit-background-clip:text;background-clip:text;color:transparent}
.meta{display:flex;gap:10px;margin-left:auto}
.meta p{margin:0;font-size:12px;color:var(--muted);font-weight:800;letter-spacing:.2px}
.search{width:92vw;max-width:720px;height:60px;border-radius:20px;border:1px solid rgba(255,255,255,.22);padding:0 16px;font-size:22px;line-height:60px;outline:none;background:#0f3c1e;color:#f6fff7;box-shadow:inset 0 0 0 1px rgba(255,255,255,.15),0 8px 20px rgba(0,0,0,.25);caret-color:#ffffff;-webkit-appearance:none;appearance:none}
.search::placeholder{color:rgba(235,255,240,.8)}
.search:focus{box-shadow:inset 0 0 0 2px var(--a2),0 0 16px rgba(61,183,255,.45)}
.btn{height:40px;border-radius:12px;border:none;padding:0 14px;font-weight:900;cursor:pointer;background:linear-gradient(90deg,var(--a1),#a9ffdf);color:#062017}
.wrap{display:flex;flex-wrap:wrap;justify-content:center;gap:12px;margin:16px auto 28px;max-width:1240px;padding:0 10px 20vh}
.card{--s:clamp(92px,26vw,124px);width:var(--s);height:calc(var(--s) + 22px);border-radius:16px;display:flex;flex-direction:column;align-items:center;justify-content:center;position:relative;font-weight:900;color:#fff;background:radial-gradient(circle at 50% 28%,rgba(255,255,255,.10) 0 18%,transparent 19%),radial-gradient(circle at 37% 42%,rgba(255,255,255,.10) 0 18%,transparent 19%),radial-gradient(circle at 63% 42%,rgba(255,255,255,.10) 0 18%,transparent 19%),linear-gradient(145deg,transparent 0 62%,rgba(255,255,255,.10) 63%,transparent 64%),linear-gradient(160deg,#0b2b15,#0a2412 60%);box-shadow:inset 0 0 0 1px rgba(255,255,255,.10),0 10px 26px rgba(0,0,0,.35);outline:none;border:none}
.card span.num{font-size:clamp(36px,8.5vw,46px);text-shadow:0 2px 10px rgba(0,0,0,.45),0 0 18px rgba(255,255,255,.18)}
.card .st{margin-top:6px;font-size:11px;font-weight:800;padding:3px 8px;border-radius:999px;background:rgba(255,255,255,.16);border:1px solid rgba(255,255,255,.28)}
.card.free .st{background:rgba(0,255,169,.18);border-color:rgba(0,255,169,.45)}
.card.busy .st{background:rgba(255,107,107,.18);border-color:rgba(255,107,107,.45)}
.card:before{content:"";position:absolute;inset:-1px;border-radius:inherit;padding:6px;background:conic-gradient(from 180deg at 50% 50%,var(--a1),var(--a2),var(--a3),var(--a1));-webkit-mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);-webkit-mask-composite:xor;mask-composite:exclude;opacity:.95}
.msg{padding:14px 16px;background:rgba(255,255,255,.12);color:#fff;border:1px solid rgba(255,255,255,.45);border-radius:14px;width:min(92vw,520px);text-align:center;font-size:clamp(16px,4.8vw,22px);font-weight:900;display:none;position:fixed;top:calc(var(--header-h) + 10px);left:50%;transform:translateX(-50%);z-index:60;box-shadow:0 12px 30px rgba(0,0,0,.35)}
.msg.error{background:#ff3b30;border-color:#ffd0d0;color:#fff}
.layer{position:fixed;top:calc(var(--header-h) + 12px);left:50%;transform:translateX(-50%);z-index:55;display:none;width:min(92vw,720px);pointer-events:auto;display:flex;flex-wrap:wrap;justify-content:center;gap:12px}
.ov{position:fixed;inset:0;background:rgba(0,0,0,.38);z-index:64;display:none}
.box{padding:28px;background:#0f3c1e;color:#ffffff;border-radius:20px;width:min(92vw,620px);text-align:center;font-size:clamp(18px,5vw,24px);font-weight:900;display:none;position:fixed;top:calc(var(--header-h) + 10px);left:50%;z-index:65;box-shadow:0 20px 60px rgba(0,0,0,.55);border:1px solid rgba(255,255,255,.18)}
.box:before{content:"";position:absolute;inset:-2px;border-radius:inherit;padding:5px;background:conic-gradient(from 180deg at 50% 50%,var(--a2),var(--a1),var(--a3),var(--a2));-webkit-mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);-webkit-mask-composite:xor;mask-composite:exclude;opacity:.95}
.actions{display:flex;gap:10px;justify-content:center;margin-top:12px}
.ok{background:linear-gradient(90deg,var(--a1),#a9ffdf);color:#062017}
.no{background:linear-gradient(90deg,#ff6b6b,#ffd0d0);color:#1a0606}
.legend{display:flex;gap:8px;align-items:center;justify-content:center;margin-top:6px;font-size:12px;color:#eaffea}
.dot{display:inline-block;width:10px;height:10px;border-radius:50%}
.dot.free{background:#69f0ae}
.dot.busy{background:#ff8a80}
@media(max-width:768px){header{flex-direction:column;gap:8px;padding:12px 10px}.search{width:92vw;max-width:92vw}.wrap{gap:10px;margin-top:12px}}
/* debug visible y grande */
#debug{
  position: fixed;
  right: 8px;
  bottom: 8px;
  max-width: 96vw;
  max-height: 60vh;
  overflow: auto;
  background: rgba(0,0,0,.85);
  color: #fff;
  padding: 12px 14px;
  border-radius: 12px;
  font: 12px/1.45 ui-monospace, Menlo, Consolas, monospace;
  z-index: 99999;
  white-space: pre-wrap;
  display: none;
  border: 1px solid rgba(255,255,255,.25);
  box-shadow: 0 8px 30px rgba(0,0,0,.55);
}
    </style>
  </head>
  <body>
    <header>
      <div>
        <img id="logo" alt="Logo">
        <h1 id="title"></h1>
      </div>
      <input id="search" class="search" type="tel" inputmode="numeric" pattern="[0-9]*" maxlength="4" enterkeyhint="search" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Buscar # de boleta…">
      <button id="btnRnd" class="btn">#ALEATORIO</button>
      <div class="meta">
        <p id="phone"></p>
        <p id="addr"></p>
      </div>
    </header>

    <div class="legend">
      <span class="dot free"></span> Libre
      <span style="width:10px"></span>
      <span class="dot busy"></span> No libre
    </div>

    <div id="layer" class="layer"></div>
    <div id="grid" class="wrap"></div>

    <div id="msg" class="msg"></div>

    <div id="ov" class="ov"></div>
    <div id="box" class="box">
      <p id="q"></p>
      <div class="actions">
        <button id="yes" class="btn ok">Sí</button>
        <button id="no" class="btn no">No</button>
      </div>
    </div>

    <div id="debug"></div>

    <script>
/* === PROXY (Cloudflare Worker) === */
const PROXY = "https://csv-proxy.jeisendigital.workers.dev";

/* === URLs vía proxy (probamos TSV y CSV) === */
const URL_TSV_RAFFLES = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSpEYmEB2HJGN2F3xokfLIvpbfGA70it6YSneM8MKc0flcXn7NfZwKgmTC3x2N8oOH1krkkJyOiakru/pub?gid=1661037065&single=true&output=tsv";
const URL_CSV_RAFFLES = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSpEYmEB2HJGN2F3xokfLIvpbfGA70it6YSneM8MKc0flcXn7NfZwKgmTC3x2N8oOH1krkkJyOiakru/pub?gid=1661037065&single=true&output=csv";
const CSV_URL_RAFFLES_TSV = PROXY + "?u=" + encodeURIComponent(URL_TSV_RAFFLES);
const CSV_URL_RAFFLES_CSV = PROXY + "?u=" + encodeURIComponent(URL_CSV_RAFFLES);

const URL_TSV_CONFIG = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSpEYmEB2HJGN2F3xokfLIvpbfGA70it6YSneM8MKc0flcXn7NfZwKgmTC3x2N8oOH1krkkJyOiakru/pub?gid=856149436&single=true&output=tsv";
const CSV_URL_CONFIG = PROXY + "?u=" + encodeURIComponent(URL_TSV_CONFIG);

const DEFAULT_WA_PHONE = "+573206413635";

/* ===== debug ===== */
const DEBUG = new URL(location.href).searchParams.get('debug') === '1';
const $dbg = document.getElementById('debug');
function dbg(...args){ if(!DEBUG) return; $dbg.style.display='block'; $dbg.textContent += args.map(x => typeof x==='string'?x:JSON.stringify(x)).join(' ') + "\n"; }

/* ===== net ===== */
function bust(u){return u+(u.includes("?")?"&":"?")+"t="+Date.now()}
async function getText(url){const r=await fetch(bust(url),{cache:"no-store",credentials:"omit"});return await r.text()}

/* ===== parser smart ===== */
function parseSmart(raw){
  if (!raw) return {rows:[], delim:',' , name:'empty'};

  // estrategia 1: split rápido por línea + split por delimitador
  const splitLines = (s)=> (s||'').split(/\r\n|\n|\r/);
  const parseFast = (s, d) => splitLines(s).map(line => line.split(d));

  // estrategia 2: parser con comillas, maneja \r sueltos
  function parseQuoted(s, d){
    if (!s) return [];
    if (s.charCodeAt(0) === 0xFEFF) s = s.slice(1);
    const rows=[]; let row=[], field='', inQ=false;
    for (let i=0;i<s.length;i++){
      const c=s[i], n=s[i+1];
      if (inQ){
        if (c==='"'){ if (n==='"'){ field+='"'; i++; } else { inQ=false; } }
        else field+=c;
      }else{
        if (c==='"'){ inQ=true; }
        else if (c===d){ row.push(field); field=''; }
        else if (c==='\n'){ row.push(field); rows.push(row); row=[]; field=''; }
        else if (c==='\r'){ row.push(field); rows.push(row); row=[]; field=''; if (n==='\n'){ i++; } }
        else field+=c;
      }
    }
    row.push(field); rows.push(row);
    return rows;
  }

  // candidatos: TSV, CSV y punto y coma (;)
  const candidates = [
    {rows: parseFast(raw, '\t'), delim:'\t', name:'fast-TSV'},
    {rows: parseQuoted(raw, '\t'), delim:'\t', name:'quoted-TSV'},
    {rows: parseFast(raw, ','), delim:',', name:'fast-CSV'},
    {rows: parseQuoted(raw, ','), delim:',', name:'quoted-CSV'},
    {rows: parseFast(raw, ';'), delim:';', name:'fast-SCSV'},
    {rows: parseQuoted(raw, ';'), delim:';', name:'quoted-SCSV'},
  ].map(c => {
    // filtra filas completamente vacías
    c.rows = c.rows.filter(r => Array.isArray(r) && r.some(v => (v??'').toString().trim()!==''));
    return c;
  });

  // elige el que más filas reales produzca
  let best = candidates[0];
  for (const c of candidates) if (c.rows.length > best.rows.length) best = c;

  // fallback: si sólo hay 1 fila pero hay muchos separadores en la primera línea, fuerza split
  if (best.rows.length === 1) {
    const line = raw.split(/\r\n|\n|\r/)[0] || raw;
    const counts = {
      tab: (line.match(/\t/g)||[]).length,
      comma: (line.match(/,/g)||[]).length,
      semi: (line.match(/;/g)||[]).length
    };
    const maxKey = Object.entries(counts).sort((a,b)=>b[1]-a[1])[0][0];
    const forceDelim = (maxKey==='tab')?'\t':(maxKey==='semi'?';':',');
    const forced = raw.split(/\r\n|\n|\r/).map(l => l.split(forceDelim)).filter(r => r.some(v => (v??'').toString().trim()!==''));
    if (forced.length > best.rows.length) {
      best = {rows: forced, delim: forceDelim, name: 'forced-'+(maxKey.toUpperCase())};
    }
  }

  dbg('Parser elegido:', best.name, 'filas:', best.rows.length);
  return {rows: best.rows, delim: best.delim, name: best.name};
}

/* ===== helpers ===== */
function norm(s){return (s||'').toString().trim().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'')}
function normalizeState(sRaw){
  if(sRaw==null) return 'ocupado';
  let s=String(sRaw).replace(/\u00A0/g,' ').replace(/[\u2000-\u200D\u202F\u205F\u3000]/g,' ')
    .trim().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');
  if(/\blibre\b/.test(s) || /\bdisponible\b/.test(s) || /\bfree\b/.test(s) || /\bvacante\b/.test(s)) return 'libre';
  return 'ocupado';
}
function findColumnIndexes(headers){
  let numIdx=-1, stIdx=-1;
  for(let i=0;i<headers.length;i++){
    const h=norm(headers[i]);
    if(numIdx===-1 && /(numero|n[úu]mero|boleta|ticket|num|#)/.test(h)) numIdx=i;
    if(stIdx===-1 && /(estado|status|disponible|libre|ocupado|asignado|reservado|vendido|pagado)/.test(h)) stIdx=i;
  }
  return {numIdx,stIdx};
}
function guessColumns(rows){
  const cols=Math.max(...rows.map(r=>r.length));
  let bestNum=-1,bestNumScore=-1,bestState=-1,bestStateScore=-1;
  for(let c=0;c<cols;c++){
    let nS=0,sS=0;
    for(let i=0;i<Math.min(rows.length,1200);i++){
      const v=(rows[i][c]||'').toString().trim();
      if(/^\d{1,8}$/.test(v)) nS++;
      const st=normalizeState(v); if(st==='libre'||st==='ocupado') sS++;
    }
    if(nS>bestNumScore){bestNumScore=nS;bestNum=c}
    if(sS>bestStateScore){bestStateScore=sS;bestState=c}
  }
  return {numIdx:bestNum,stIdx:bestState};
}

/* ===== state ===== */
let allMap={};
let waPhone=DEFAULT_WA_PHONE;

/* ===== UI ===== */
function showMsg(t,err){const m=document.getElementById("msg");m.textContent=t||"";m.classList.toggle("error",!!err);m.style.display="block";clearTimeout(showMsg._t);showMsg._t=setTimeout(()=>m.style.display="none",err?2500:1200)}
function card(num,status){
  const d=document.createElement("div");
  d.className="card "+(status==='libre'?'free':'busy');
  d.innerHTML=`<span class="num">${num}</span><span class="st">${status==='libre'?'Libre':'No libre'}</span>`;
  d.addEventListener("click",()=>confirmNum(num));
  return d;
}
function renderGridAll(list){const g=document.getElementById("grid");g.innerHTML="";list.forEach(it=>g.appendChild(card(it.num,it.status)))}
function renderSearch(list){const l=document.getElementById("layer");l.style.display="none";l.innerHTML="";if(!list||!list.length)return;list.forEach(n=>l.appendChild(card(n,'libre')));l.style.display="flex"}

/* ===== WhatsApp ===== */
function confirmNum(n){
  const ov=document.getElementById("ov");const b=document.getElementById("box");
  document.getElementById("q").textContent="¿Quieres separar este número? "+n;
  ov.style.display="block";b.style.display="block";
  document.getElementById("yes").onclick=()=>{closeBox();openWA(n)};
  document.getElementById("no").onclick=closeBox;
}
function closeBox(){document.getElementById("ov").style.display="none";document.getElementById("box").style.display="none"}
function normPhone(p){const d=(p||"").replace(/\D/g,"");if(!d) return DEFAULT_WA_PHONE; if(d.startsWith("57")) return "+"+d; if(d.length===10) return "+57"+d; return "+"+d}
function openWA(n){const msg="Hola, estoy interesado en separar este número: "+n;const url="https://api.whatsapp.com/send?phone="+encodeURIComponent(waPhone)+"&text="+encodeURIComponent(msg);window.open(url,"_blank")}

/* ===== config ===== */
async function loadConfig(){
  try{
    const raw=await getText(CSV_URL_CONFIG);
    const {rows}=parseSmart(raw);
    dbg('CONFIG filas:', rows.length);

    if(!rows.length) return;
    let h=-1; for(let i=0;i<rows.length;i++){ if(rows[i].filter(x=>(x||'').trim()!=='').length>=2){h=i;break;} }
    if(h===-1) return;
    const headers=rows[h].map(x=>(x||'').toString().trim());
    let d=-1; for(let j=h+1;j<rows.length;j++){ if(rows[j].filter(x=>(x||'').trim()!=='').length>=1){d=j;break;} }
    if(d===-1) return;
    const vals=rows[d];

    const cfg={}; for(let k=0;k<headers.length;k++){ const key=headers[k]; if(!key) continue; cfg[key]=(vals[k]||'').toString(); }
    const name=cfg["Nombre_De_La_Rifa"]||cfg["Nombre"]||cfg["Nombre_Comercial"]||"";
    const phone=cfg["Telefonos"]||cfg["Telefono"]||cfg["Teléfono"]||"";
    const address=cfg["Direccion"]||cfg["Dirección"]||"";
    const logoUrl=cfg["Logo"]||"";

    document.getElementById("title").textContent=name;
    document.getElementById("phone").textContent=phone?("Tel: "+phone):"";
    document.getElementById("addr").textContent=address?("Dir: "+address):"";
    if(logoUrl) document.getElementById("logo").src=logoUrl;
    waPhone=normPhone(phone)||DEFAULT_WA_PHONE;
  }catch(e){ showMsg("No se pudo cargar la configuración",true); dbg('CONFIG error:', String(e)); }
}

/* ===== rifas: lee TODAS las filas ===== */
async function syncMap(){
  try{
    // 0) RAW preview cuando debug
    let raw = await getText(CSV_URL_RAFFLES_TSV);
    if (DEBUG) { $dbg.style.display='block'; $dbg.textContent='RAW preview (primeros 1500 chars TSV):\n'+raw.slice(0,1500)+'\n---\n'; }

    // 1) parsear TSV; si da pocas filas, intenta CSV y deja que parseSmart elija mejor
    let parsed = parseSmart(raw);
    if (parsed.rows.length < 3) {
      dbg('Pocas filas con TSV, probando CSV…');
      raw = await getText(CSV_URL_RAFFLES_CSV);
      if (DEBUG) { $dbg.textContent += 'RAW preview (primeros 1500 chars CSV):\n'+raw.slice(0,1500)+'\n---\n'; }
      parsed = parseSmart(raw);
    }
    const rows = parsed.rows;
    dbg('RAFFLES filas finales:', rows.length, 'delim:', parsed.delim);

    if(!rows.length){ renderGridAll([]); showMsg("No hay datos (no se pudo parsear)",true); return; }

    // detectar encabezados (si existen)
    let headerRowIdx=-1, headers=[];
    for(let i=0;i<Math.min(5,rows.length);i++){
      const a=(rows[i][0]||'').toString(), b=(rows[i][1]||'').toString();
      const an=norm(a), bn=norm(b);
      const looksHeader=(/[a-z]/.test(an)&&/[a-z]/.test(bn))||
                        /(numero|n[úu]mero|boleta|ticket)/.test(an)||
                        /(estado|status|disponible|libre|ocupado|asignado|reservado|vendido|pagado)/.test(bn);
      if(looksHeader){ headerRowIdx=i; headers=rows[i].map(x=>(x||'').toString()); break; }
    }

    let numIdx=0, stIdx=1, dataStart=0, by='default';
    if(headerRowIdx!==-1){
      const idxs=findColumnIndexes(headers);
      if(idxs.numIdx!==-1) numIdx=idxs.numIdx;
      if(idxs.stIdx!==-1)  stIdx=idxs.stIdx;
      dataStart=headerRowIdx+1; by='headers';
    }else{
      const g=guessColumns(rows.slice(0,Math.min(rows.length,1200)));
      if(g.numIdx!==-1) numIdx=g.numIdx;
      if(g.stIdx!==-1)  stIdx=g.stIdx;
      by='guess';
    }
    dbg('Columnas por', by, ' -> numIdx:', numIdx, 'stIdx:', stIdx, 'dataStart:', dataStart);

    const items=[];
    let sample=[];
    for(let i=dataStart;i<rows.length;i++){
      let num=(rows[i][numIdx]||'').toString().trim();
      let st =normalizeState(rows[i][stIdx]);
      if(!num) continue;
      num=num.replace(/\D/g,''); if(!num) continue;
      num=num.padStart(4,'0');
      items.push({num, status:st});
      if(sample.length<3) sample.push([rows[i][numIdx], rows[i][stIdx]]);
    }
    dbg('Muestra (num, estado):', sample);

    if(!items.length){ renderGridAll([]); showMsg("No hay filas válidas",true); return; }

    items.sort((a,b)=>a.num.localeCompare(b.num));
    renderGridAll(items);

    // llena allMap para el buscador
    const m={}; items.forEach(it=>m[it.num]=it.status); allMap=m;

  }catch(e){
    renderGridAll([]);
    showMsg("Error de conexión al leer rifas",true);
    dbg('RAFFLES error:', String(e));
  }
}

/* ===== buscador ===== */
function rerenderSearch(){
  const el=document.getElementById("search");
  const raw=(el.value||"").replace(/\D/g,"").slice(0,4);
  if(el.value!==raw) el.value=raw;
  const layer=document.getElementById("layer"); layer.style.display="none"; layer.innerHTML="";
  if(raw.length===0){document.body.classList.remove("has-text");return}
  document.body.classList.add("has-text");
  const padded=raw.padStart(4,"0");
  const found = Object.prototype.hasOwnProperty.call(allMap, padded) ? [{num:padded}] : [];
  if(found.length){ found.forEach(f=>layer.appendChild(card(f.num, allMap[f.num]||'ocupado'))); layer.style.display="flex"; }
  else { showMsg("Número no encontrado",true); }
}

/* ===== init ===== */
document.addEventListener("DOMContentLoaded",()=>{
  const s=document.getElementById("search");
  s.addEventListener("input",e=>{const v=e.target.value.replace(/\D/g,"").slice(0,4);if(e.target.value!==v)e.target.value=v;rerenderSearch()});
  document.getElementById("btnRnd").addEventListener("click",()=>{
    const keys=Object.keys(allMap); if(!keys.length){showMsg("No hay datos");return}
    const rnd=keys[Math.floor(Math.random()*keys.length)];
    s.value=parseInt(rnd,10).toString();document.body.classList.add("has-text");renderSearch([{num:rnd}]);
  });
  document.getElementById("ov").addEventListener("click",()=>{closeBox()});

  loadConfig();
  syncMap();
  setInterval(syncMap, 5000);
});
    </script>
  </body>
</html>
