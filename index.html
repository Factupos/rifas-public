<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Boletas de Rifa</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, interactive-widget=overlays-content">
  <link rel="icon" href="data:,">
  <style>
:root{--bg:#129a3a;--bg-deep:#0e7f30;--ink:#fff;--muted:#e5ffe8;--a1:#00ffa9;--a2:#3db7ff;--a3:#ffb24d;--header-h:96px}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%}
body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--ink);background:var(--bg);line-height:1.2;padding-top:calc(var(--header-h)+10px);overscroll-behavior-y:contain;touch-action:manipulation}
header{position:fixed;left:0;right:0;top:10px;z-index:30;display:flex;align-items:center;gap:10px;padding:10px 14px;min-height:96px;background:linear-gradient(0deg,rgba(0,0,0,.18),rgba(0,0,0,.18)),var(--bg-deep);border-bottom:1px solid rgba(255,255,255,.12);box-shadow:0 10px 26px rgba(0,0,0,.35)}
header .brand{display:flex;align-items:center;gap:12px}
#logo{height:56px;width:56px;object-fit:cover;border-radius:50%;border:2px solid rgba(255,255,255,.2);box-shadow:0 0 0 2px rgba(255,255,255,.18),0 0 22px rgba(0,0,0,.25)}
#title{margin:0;font-weight:900;font-size:clamp(18px,3.2vw,24px);letter-spacing:.5px;background:linear-gradient(90deg,#fff,var(--a2) 50%,var(--a1) 90%);-webkit-background-clip:text;background-clip:text;color:transparent}
.meta{display:flex;gap:10px;margin-left:auto}.meta p{margin:0;font-size:12px;color:var(--muted);font-weight:800;letter-spacing:.2px}
.search{width:92vw;max-width:720px;height:60px;border-radius:20px;border:1px solid rgba(255,255,255,.22);padding:0 16px;font-size:22px;line-height:60px;outline:none;background:#0f3c1e;color:#f6fff7;box-shadow:inset 0 0 0 1px rgba(255,255,255,.15),0 8px 20px rgba(0,0,0,.25)}
.search::placeholder{color:rgba(235,255,240,.8)}.search:focus{box-shadow:inset 0 0 0 2px var(--a2),0 0 16px rgba(61,183,255,.45)}
.btn{height:42px;border-radius:12px;border:none;padding:0 14px;font-weight:900;cursor:pointer;background:linear-gradient(90deg,var(--a1),#a9ffdf);color:#062017}
.wrap{display:flex;flex-wrap:wrap;justify-content:center;gap:12px;margin:16px auto 28px;max-width:1240px;padding:0 10px 20vh}
.card{--s:clamp(92px,26vw,124px);width:var(--s);height:calc(var(--s)+22px);border-radius:16px;display:flex;flex-direction:column;align-items:center;justify-content:center;position:relative;font-weight:900;color:#fff;background:radial-gradient(circle at 50% 28%,rgba(255,255,255,.10) 0 18%,transparent 19%),radial-gradient(circle at 37% 42%,rgba(255,255,255,.10) 0 18%,transparent 19%),radial-gradient(circle at 63% 42%,rgba(255,255,255,.10) 0 18%,transparent 19%),linear-gradient(145deg,transparent 0 62%,rgba(255,255,255,.10) 63%,transparent 64%),linear-gradient(160deg,#0b2b15,#0a2412 60%);box-shadow:inset 0 0 0 1px rgba(255,255,255,.10),0 10px 26px rgba(0,0,0,.35);cursor:pointer}
.card span.num{font-size:clamp(36px,8.5vw,46px);text-shadow:0 2px 10px rgba(0,0,0,.45),0 0 18px rgba(255,255,255,.18)}
.card .st{margin-top:6px;font-size:11px;font-weight:800;padding:3px 8px;border-radius:999px;background:rgba(0,255,169,.18);border:1px solid rgba(0,255,169,.45)}
.msg{padding:14px 16px;background:rgba(255,255,255,.12);color:#fff;border:1px solid rgba(255,255,255,.45);border-radius:14px;width:min(92vw,520px);text-align:center;font-size:clamp(16px,4.8vw,22px);font-weight:900;display:none;position:fixed;top:calc(var(--header-h)+10px);left:50%;transform:translateX(-50%);z-index:60;box-shadow:0 12px 30px rgba(0,0,0,.35)}
.msg.error{background:#ff3b30;border-color:#ffd0d0}
.layer{position:fixed;top:calc(var(--header-h)+12px);left:50%;transform:translateX(-50%);z-index:55;display:none;width:min(92vw,720px);display:flex;flex-wrap:wrap;justify-content:center;gap:12px}
.ov{position:fixed;inset:0;background:rgba(0,0,0,.4);backdrop-filter:saturate(120%) blur(2px);z-index:90;display:none}
.box{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);z-index:95;min-width:min(92vw,520px);max-width:92vw;background:#0f3c1e;color:#fff;border-radius:20px;border:1px solid rgba(255,255,255,.18);box-shadow:0 20px 60px rgba(0,0,0,.55);padding:20px 18px;text-align:center;display:none}
.box .q{font-size:clamp(18px,5vw,22px);font-weight:900;margin:6px 0 14px}
.actions{display:flex;gap:10px;justify-content:center;margin-top:4px}
.btn.ok{background:linear-gradient(90deg,var(--a1),#a9ffdf);color:#062017}
.btn.no{background:linear-gradient(90deg,#ff6b6b,#ffd0d0);color:#1a0606}
.legend{display:flex;gap:8px;align-items:center;justify-content:center;margin-top:6px;font-size:12px;color:#eaffea}
.dot{display:inline-block;width:10px;height:10px;border-radius:50%}
.dot.free{background:#69f0ae}
@media(max-width:768px){header{flex-direction:column;gap:8px;padding:12px 10px}.search{width:92vw;max-width:92vw}.wrap{gap:10px;margin-top:12px}}
#debug{position:fixed;right:8px;bottom:8px;max-width:96vw;max-height:60vh;overflow:auto;background:rgba(0,0,0,.85);color:#fff;padding:12px 14px;border-radius:12px;font:12px/1.45 ui-monospace,Menlo,Consolas,monospace;z-index:99999;white-space:pre-wrap;display:none;border:1px solid rgba(255,255,255,.25);box-shadow:0 8px 30px rgba(0,0,0,.55)}
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <img id="logo" alt="Logo" />
      <h1 id="title"></h1>
    </div>
    <input id="search" class="search" type="tel" inputmode="numeric" pattern="[0-9]*" maxlength="4" placeholder="Buscar # de boleta…" />
    <button id="btnRnd" class="btn">#ALEATORIO</button>
    <div class="meta"><p id="phone"></p><p id="addr"></p></div>
  </header>

  <div class="legend"><span class="dot free"></span> Solo se muestran boletas libres (máx. 400 diarias)</div>

  <div id="layer" class="layer"></div>
  <div id="grid" class="wrap"></div>
  <div id="msg" class="msg"></div>

  <div id="ov" class="ov" aria-hidden="true"></div>
  <div id="box" class="box" role="dialog" aria-modal="true">
    <p id="q" class="q"></p>
    <div class="actions">
      <button id="yes" class="btn ok" type="button">Sí</button>
      <button id="no" class="btn no" type="button">No</button>
    </div>
  </div>

  <div id="debug"></div>

  <script>
/* ===== CONFIG URLs (ajusta si cambian) ===== */
const PROXY = "https://csv-proxy.jeisendigital.workers.dev";
const SPREADSHEET_ID = "1MyOkJrGpeY1ZXQVFq_srndALEh6Nzzir8sFSfu-0EVM";
const GID_RAFFLES    = "1661037065";   // Numero_De_Rifas
const GID_CONFIG     = "856149436";    // Config_Publica

const URL_TSV_RAFFLES  = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/export?format=tsv&gid=${GID_RAFFLES}`;
const URL_CSV_RAFFLES  = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/export?format=csv&gid=${GID_RAFFLES}`;
const URL_GVIZ_RAFFLES = `https://docs.google.com/spreadsheets/d/e/2PACX-1vSpEYmEB2HJGN2F3xokfLIvpbfGA70it6YSneM8MKc0flcXn7NfZwKgmTC3x2N8oOH1krkkJyOiakru/gviz/tq?tqx=out:tsv&gid=${GID_RAFFLES}`;
const URL_TSV_CONFIG   = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/export?format=tsv&gid=${GID_CONFIG}`;

const CSV_URL_RAFFLES_TSV  = PROXY + "?u=" + encodeURIComponent(URL_TSV_RAFFLES);
const CSV_URL_RAFFLES_CSV  = PROXY + "?u=" + encodeURIComponent(URL_CSV_RAFFLES);
const CSV_URL_RAFFLES_GVIZ = PROXY + "?u=" + encodeURIComponent(URL_GVIZ_RAFFLES);
const CSV_URL_CONFIG       = PROXY + "?u=" + encodeURIComponent(URL_TSV_CONFIG);

const DEFAULT_WA_PHONE = "+573206413635";

/* ===== DEBUG ===== */
const DEBUG = new URL(location.href).searchParams.get('debug') === '1';
const $dbg = document.getElementById('debug');
function dbg(){ if(!DEBUG) return; $dbg.style.display='block'; $dbg.textContent += Array.from(arguments).map(x=>typeof x==='string'?x:JSON.stringify(x)).join(' ') + "\n"; }

/* ===== UTILES ===== */
function todayKey(){ return (new Date()).toDateString(); }
function bust(u){return u+(u.includes("?")?"&":"?")+"t="+Date.now()}
async function getText(url){ const r=await fetch(bust(url),{cache:"no-store",credentials:"omit"}); return await r.text(); }
function parseSmart(raw){
  const split=(s)=> (s||'').split(/\r\n|\n|\r/);
  const fast=(s,d)=> split(s).map(l=>l.split(d));
  function quoted(s,d){
    if (!s) return [];
    if (s.charCodeAt(0)===0xFEFF) s=s.slice(1);
    const rows=[]; let row=[],f='',q=false;
    for(let i=0;i<s.length;i++){
      const c=s[i],n=s[i+1];
      if(q){ if(c==='"'){ if(n==='"'){ f+='"'; i++; } else q=false; } else f+=c; }
      else{ if(c==='"') q=true; else if(c===d){ row.push(f); f=''; } else if(c==='\n'){ row.push(f); rows.push(row); row=[]; f=''; }
      else if(c==='\r'){ row.push(f); rows.push(row); row=[]; f=''; if(n==='\n') i++; } else f+=c; }
    } row.push(f); rows.push(row); return rows;
  }
  const cand=[['\t','fast-TSV',fast],['\t','quoted-TSV',quoted],[',','fast-CSV',fast],[',','quoted-CSV',quoted],[';','fast-SCSV',fast],[';','quoted-SCSV',quoted]].map(([d,n,f])=>({rows:f(raw,d).filter(r=>r.some(v=>(v??'').toString().trim()!=='')),delim:d,name:n}));
  let best=cand.reduce((a,b)=>b.rows.length>a.rows.length?b:a,cand[0]);
  if(best.rows.length===1){
    const line=raw.split(/\r\n|\n|\r/)[0]||raw, counts={tab:(line.match(/\t/g)||[]).length,comma:(line.match(/,/g)||[]).length,semi:(line.match(/;/g)||[]).length};
    const k=Object.entries(counts).sort((x,y)=>y[1]-x[1])[0][0]; const d=k==='tab'?'\t':k==='semi'?';':','; const forced=raw.split(/\r\n|\n|\r/).map(l=>l.split(d)).filter(r=>r.some(v=>(v??'').toString().trim()!=='')); if(forced.length>best.rows.length) best={rows:forced,delim:d,name:'forced-'+k};
  }
  dbg('Parser elegido:',best.name,'filas:',best.rows.length);
  return best;
}
function norm(s){return (s||'').toString().trim().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'')}
function normalizeState(v){
  let s=(v??'').toString().replace(/\u00A0/g,' ').trim().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');
  return /\b(libre|disponible|free|vacante)\b/.test(s)?'libre':'ocupado';
}
function findColumnIndexes(headers){
  let numIdx=-1,stIdx=-1;
  for(let i=0;i<headers.length;i++){
    const h=norm(headers[i]);
    if(numIdx===-1 && /(numero|n[úu]mero|boleta|ticket|num|#)/.test(h)) numIdx=i;
    if(stIdx===-1 && /(estado|status|disponible|libre|ocupado|asignado|reservado|vendido|pagado)/.test(h)) stIdx=i;
  }
  return {numIdx,stIdx};
}
function guessCols(rows){
  const cols=Math.max(...rows.map(r=>r.length));
  let bestN=-1,bestNS=-1,bestS=-1,bestSS=-1;
  for(let c=0;c<cols;c++){
    let nS=0,sS=0;
    for(let i=0;i<Math.min(rows.length,800);i++){
      const v=(rows[i][c]||'').toString().trim();
      if(/^\d{1,8}$/.test(v)) nS++;
      const st=normalizeState(v); if(st==='libre'||st==='ocupado') sS++;
    }
    if(nS>bestNS){bestNS=nS;bestN=c}
    if(sS>bestSS){bestSS=sS;bestS=c}
  }
  return {numIdx:bestN,stIdx:bestS};
}

/* ===== ESTADO ===== */
let waPhone = DEFAULT_WA_PHONE;   // Ajustado por Config
let allMap = {};                  // num -> 'libre'|'ocupado'

/* ===== UI helpers ===== */
const $msg = document.getElementById("msg");
function showMsg(t,err){$msg.textContent=t||"";$msg.classList.toggle("error",!!err);$msg.style.display="block";clearTimeout(showMsg._t);showMsg._t=setTimeout(()=>{$msg.style.display="none"},err?2500:1200)}
function card(num){const d=document.createElement("div");d.className="card";d.innerHTML=`<span class="num">${num}</span><span class="st">Libre</span>`;d.addEventListener("click",()=>confirmNum(num));return d}
function renderGridFromList(nums){const g=document.getElementById("grid");g.innerHTML="";nums.forEach(n=>g.appendChild(card(n)))}
function renderSearch(nums){const l=document.getElementById("layer");l.style.display="none";l.innerHTML="";if(!nums||!nums.length)return;nums.forEach(n=>l.appendChild(card(n)));l.style.display="flex"}
function confirmNum(n){
  const ov=document.getElementById("ov");
  const box=document.getElementById("box");
  document.getElementById("q").textContent="¿Quieres separar este número? "+n;
  ov.style.display="block"; box.style.display="block";
  // Re-vinculamos en cada apertura para evitar handlers “fantasma”
  const yes=document.getElementById("yes"), no=document.getElementById("no");
  yes.onclick = ()=>{
    closeBox();
    openWA(n);
  };
  no.onclick = closeBox;
}
function closeBox(){document.getElementById("ov").style.display="none";document.getElementById("box").style.display="none"}
function openWA(n){
  const msg = "Hola, estoy interesado en separar este número: "+n;
  const url = "https://api.whatsapp.com/send?phone="+encodeURIComponent(waPhone)+"&text="+encodeURIComponent(msg);
  // compatibilidad in-app: intentamos _blank y, si falla, usamos location.href
  const w = window.open(url,"_blank");
  if(!w || w.closed || typeof w.closed==="undefined"){ location.href = url; }
}

/* ===== CARGA CONFIG ===== */
async function loadConfig(){
  try{
    const raw=await getText(CSV_URL_CONFIG);
    const parsed=parseSmart(raw); const rows=parsed.rows;
    if(!rows.length) return;
    // primera fila con cabeceras + fila de datos siguiente
    let h=-1; for(let i=0;i<rows.length;i++){ if(rows[i].filter(x=>(x||'').trim()!=='').length>=2){h=i;break;} }
    if(h===-1) return;
    const headers=rows[h].map(x=>(x||'').toString().trim());
    let d=-1; for(let j=h+1;j<rows.length;j++){ if(rows[j].filter(x=>(x||'').trim()!=='').length>=1){d=j;break;} }
    if(d===-1) return;
    const vals=rows[d], cfg={}; for(let k=0;k<headers.length;k++){ const key=headers[k]; if(!key) continue; cfg[key]=(vals[k]||'').toString(); }
    const name=cfg["Nombre_De_La_Rifa"]||cfg["Nombre"]||cfg["Nombre_Comercial"]||"";
    const phone=cfg["Telefonos"]||cfg["Telefono"]||cfg["Teléfono"]||"";
    const address=cfg["Direccion"]||cfg["Dirección"]||"";
    const logoUrl=cfg["Logo"]||"";
    document.getElementById("title").textContent=name;
    document.getElementById("phone").textContent=phone?("Tel: "+phone):"";
    document.getElementById("addr").textContent=address?("Dir: "+address):"";
    if(logoUrl) document.getElementById("logo").src=logoUrl;
    const dphone=(phone||"").replace(/\D/g,"");
    if(dphone){ waPhone = dphone.startsWith("57")?("+"+dphone):(dphone.length===10?"+57"+dphone:"+"+dphone); }
  }catch(e){ dbg('CONFIG error:',String(e)); }
}

/* ===== LECTURA RIFAS ===== */
async function fetchRafflesRawInOrder(){
  const list=[CSV_URL_RAFFLES_TSV, CSV_URL_RAFFLES_CSV, CSV_URL_RAFFLES_GVIZ];
  for(const src of list){
    const txt=await getText(src);
    const t=txt.trim();
    if(t.startsWith('{') && t.includes('"google_returned_html"')){ dbg('Descartado worker JSON error'); continue; }
    if(/<!doctype html|<html/i.test(t)){ dbg('Descartado HTML'); continue; }
    return {raw:txt,src};
  }
  throw new Error('Sin fuente válida (login/HTML).');
}
async function loadRaffles(){
  const {raw}=await fetchRafflesRawInOrder();
  const parsed=parseSmart(raw); const rows=parsed.rows;
  if(!rows.length) return {items:[], map:{}};
  // detectar headers
  let headerRowIdx=-1, headers=[];
  for(let i=0;i<Math.min(5,rows.length);i++){
    const a=(rows[i][0]||'').toString(), b=(rows[i][1]||'').toString();
    const an=norm(a), bn=norm(b);
    const looksHeader=(/[a-z]/.test(an)&&/[a-z]/.test(bn))||
                      /(numero|n[úu]mero|boleta|ticket)/.test(an)||
                      /(estado|status|disponible|libre|ocupado|asignado|reservado|vendido|pagado)/.test(bn);
    if(looksHeader){ headerRowIdx=i; headers=rows[i].map(x=>(x||'').toString()); break; }
  }
  let numIdx=0, stIdx=1, dataStart=0;
  if(headerRowIdx!==-1){ const idxs=findColumnIndexes(headers); if(idxs.numIdx!==-1) numIdx=idxs.numIdx; if(idxs.stIdx!==-1) stIdx=idxs.stIdx; dataStart=headerRowIdx+1; }
  else { const g=guessCols(rows); if(g.numIdx!==-1) numIdx=g.numIdx; if(g.stIdx!==-1) stIdx=g.stIdx; }

  const items=[], map={};
  for(let i=dataStart;i<rows.length;i++){
    let num=(rows[i][numIdx]||'').toString().trim(); if(!num) continue;
    num=num.replace(/\D/g,''); if(!num) continue; num=num.padStart(4,'0');
    const st=normalizeState(rows[i][stIdx]);
    items.push({num, status:st}); map[num]=st;
  }
  items.sort((a,b)=>a.num.localeCompare(b.num));
  return {items, map};
}

/* ===== LÓGICA “DIARIA 400 LIBRES” (igual Apps Script) ===== */
function pickRandom(arr, n){
  const a=arr.slice();
  for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; }
  return a.slice(0,n);
}
function computeDailyFree(map){
  const libres = Object.keys(map).filter(k=>map[k]==='libre');
  const today = todayKey();
  const kR='dailyRaffles', kD='lastUpdate';
  let daily = JSON.parse(localStorage.getItem(kR)||'[]');
  const last = localStorage.getItem(kD)||'';

  if(last!==today || daily.length===0){
    daily = pickRandom(libres, 400);
    localStorage.setItem(kR, JSON.stringify(daily));
    localStorage.setItem(kD, today);
  }else{
    // depurar por cambios de estado (si alguna se ocupó ya no aparecerá)
    daily = daily.filter(x=>map[x]==='libre');
    localStorage.setItem(kR, JSON.stringify(daily));
  }
  return daily;
}

/* ===== SINCRONIZACIÓN ===== */
async function syncAll(){
  try{
    const {items,map}=await loadRaffles();
    allMap = map;
    const daily = computeDailyFree(allMap);         // <-- SOLO 400 libres
    renderGridFromList(daily);                      // <-- solo libres / no ocupadas
  }catch(e){ showMsg("Error al sincronizar rifas",true); dbg(e); }
}

/* ===== BUSCADOR ===== */
function rerenderSearch(){
  const s=document.getElementById("search");
  const raw=(s.value||"").replace(/\D/g,"").slice(0,4);
  if(s.value!==raw) s.value=raw;
  const layer=document.getElementById("layer"); layer.style.display="none"; layer.innerHTML="";
  if(raw.length===0) return;
  const padded=raw.padStart(4,"0");
  if(!(padded in allMap)){ showMsg("Verificando disponibilidad…"); return; }
  if(allMap[padded]==='libre') renderSearch([padded]); else showMsg("Boleta ocupada",true);
}

/* ===== INIT ===== */
document.addEventListener("DOMContentLoaded",()=>{
  const s=document.getElementById("search");
  s.addEventListener("input",e=>{const v=e.target.value.replace(/\D/g,"").slice(0,4);if(e.target.value!==v)e.target.value=v;rerenderSearch()});

  document.getElementById("btnRnd").addEventListener("click",()=>{
    const libres=Object.keys(allMap).filter(k=>allMap[k]==='libre');
    if(!libres.length){showMsg("No hay boletas libres por ahora");return}
    const rnd=libres[Math.floor(Math.random()*libres.length)];
    s.value=parseInt(rnd,10).toString(); renderSearch([rnd]);
  });

  // cerrar modal tocando fuera
  document.getElementById("ov").addEventListener("click",closeBox);

  loadConfig();
  syncAll();                    // primera carga
  setInterval(syncAll, 5000);  // refresco cada 5s (igual Apps Script)
});
  </script>
</body>
</html>
