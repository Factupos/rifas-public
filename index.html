<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <title>Boletas de Rifa</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, interactive-widget=overlays-content">
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
  <style>
:root{
  --bg:#129a3a; --bg-deep:#0e7f30; --ink:#ffffff; --muted:#e5ffe8;
  --accent1:#00ffa9; --accent2:#3db7ff; --accent3:#ffb24d;
  --header-h:90px; --vv-top:0px; --extra-top:0px;
}

*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%} html{overflow-anchor:none}
body{
  margin:0; font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  color:var(--ink); background:var(--bg);
  -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  line-height:1.2;
  padding-top:calc(var(--header-h) + var(--vv-top) + var(--extra-top));
  overscroll-behavior-y:contain; touch-action:manipulation;
}

.top-veil{
  position:fixed; left:0; right:0; top:0;
  height:calc(var(--vv-top) + var(--extra-top) + var(--header-h) + 16px);
  z-index:25; pointer-events:none;
  background:linear-gradient(180deg,
    rgba(14,127,48,.94) 0%,
    rgba(14,127,48,.88) 40%,
    rgba(14,127,48,.72) 70%,
    rgba(14,127,48,0) 100%);
  -webkit-backdrop-filter:saturate(120%) blur(6px);
  backdrop-filter:saturate(120%) blur(6px);
  border-bottom:1px solid rgba(255,255,255,.12);
}

header{
  position:fixed; left:0; right:0; z-index:30;
  top:calc(var(--vv-top) + var(--extra-top));
  display:flex;align-items:center;gap:10px;flex-wrap:wrap;
  padding:10px 14px; min-height:90px;
  background:linear-gradient(0deg,rgba(0,0,0,.18),rgba(0,0,0,.18)), var(--bg-deep);
  border-bottom:1px solid rgba(255,255,255,.12);
  box-shadow:0 10px 26px rgba(0,0,0,.35);
}
/* --- FIX PARPADEO/MOVIMIENTO ENCABEZADO EN MÓVIL (sin cambiar nada más) --- */
header{ top:0 !important; transform:translateZ(0); -webkit-transform:translateZ(0); backface-visibility:hidden; contain:paint; }

.brand{display:flex;align-items:center;gap:12px}
.brand img{
  height:56px;width:56px;object-fit:cover;border-radius:50%;
  border:2px solid rgba(255,255,255,.2);
  box-shadow:0 0 0 2px rgba(255,255,255,.18),0 0 22px rgba(0,0,0,.25);
}
.brand h1{
  margin:0;font-weight:900;font-size:clamp(18px,3.2vw,24px);letter-spacing:.5px;
  background:linear-gradient(90deg,#fff,var(--accent2) 50%,var(--accent1) 90%);
  -webkit-background-clip:text;background-clip:text;color:transparent;
}

.search-bar{
  flex:1 1 320px;
  height:56px;
  border-radius:16px; border:1px solid rgba(255,255,255,.22);
  padding:0 14px; font-size:20px; line-height:56px;
  outline:none; background:#0f3c1e; color:#f6fff7;
  box-shadow:inset 0 0 0 1px rgba(255,255,255,.15),0 8px 20px rgba(0,0,0,.25);
  touch-action:manipulation; caret-color:#ffffff;
  -webkit-appearance:none; appearance:none; transform:translateZ(0);
  scroll-margin-top:14vh;
}
.search-bar::placeholder{color:rgba(235,255,240,.8)}
.search-bar:focus{box-shadow:inset 0 0 0 2px var(--accent2),0 0 16px rgba(61,183,255,.45)}

.random-button{
  height:56px; border-radius:16px;
  padding:0 16px; font-weight:900; letter-spacing:.5px;
  border:none; cursor:pointer; color:#062017;
  background:linear-gradient(90deg,var(--accent1),#a9ffdf);
}

.contact-info{display:flex;flex-direction:row;align-items:center;gap:10px;margin-left:auto}
.contact-info p{margin:0;font-size:12px;color:var(--muted);font-weight:800;letter-spacing:.2px}

.search-result{
  position:fixed;
  top:calc(var(--vv-top) + var(--extra-top) + var(--header-h) + 12px);
  left:50%;
  transform:translateX(-50%);
  z-index:55;
  display:none;
  width:min(92vw,720px);
  pointer-events:auto;
  display:flex;flex-wrap:wrap;justify-content:center;gap:12px;
}

body.search-has-text header{ z-index:200; }
body.search-has-text #raffles{
  content-visibility:hidden;
  contain-intrinsic-size:1000px 1600px;
}
body.search-has-text *{ transition:none !important; }

#raffles{
  display:flex;flex-wrap:wrap;justify-content:center;gap:12px;
  margin:16px auto 28px;max-width:1240px;padding:0 10px 20vh;
}

.raffle{
  --size:clamp(92px,26vw,124px);
  width:var(--size);height:calc(var(--size) + 16px);
  border-radius:16px;display:flex;align-items:center;justify-content:center;
  position:relative;font-weight:900;color:#fff;
  background:
    radial-gradient(circle at 50% 28%, rgba(255,255,255,.10) 0 18%, transparent 19%),
    radial-gradient(circle at 37% 42%, rgba(255,255,255,.10) 0 18%, transparent 19%),
    radial-gradient(circle at 63% 42%, rgba(255,255,255,.10) 0 18%, transparent 19%),
    linear-gradient(145deg, transparent 0 62%, rgba(255,255,255,.10) 63%, transparent 64%),
    linear-gradient(160deg,#0b2b15,#0a2412 60%) ;
  box-shadow:inset 0 0 0 1px rgba(255,255,255,.10),0 10px 26px rgba(0,0,0,.35);
  outline:none;cursor:pointer;border:none;transform:translateZ(0);
}
.raffle span{
  font-size:clamp(38px,8.5vw,48px);line-height:1;
  text-shadow:0 2px 10px rgba(0,0,0,.45),0 0 18px rgba(255,255,255,.18);
}
.raffle::before{
  content:"";position:absolute;inset:-1px;border-radius:inherit;padding:6px;
  background:conic-gradient(from 180deg at 50% 50%,var(--accent1),var(--accent2),var(--accent3),var(--accent1));
  -webkit-mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);
  -webkit-mask-composite:xor;mask-composite:exclude;opacity:.95;
}
.raffle::after{
  content:"";position:absolute;inset:2px;border-radius:14px;
  background:radial-gradient(60% 60% at 50% 45%, rgba(255,255,255,.08), transparent 70%);
  z-index:0;
}

.large-raffle{--size:clamp(160px,52vw,200px);width:var(--size);height:calc(var(--size) + 18px)}
.large-raffle span{font-size:clamp(50px,12vw,70px)}

.message{
  padding:14px 16px;background:rgba(255,255,255,.12);color:#fff;border:1px solid rgba(255,255,255,.45);
  border-radius:14px;width:min(92vw,420px);text-align:center;
  font-size:clamp(16px,4.8vw,22px);font-weight:900;display:none;
  position:fixed;top:calc(var(--vv-top) + var(--extra-top) + var(--header-h) + 10px);left:50%;transform:translateX(-50%);
  z-index:60;box-shadow:0 12px 30px rgba(0,0,0,.35);
}
.message.error{
  background:linear-gradient(0deg,#ff3b30,#ff3b30) !important;
  border-color:#ffd0d0 !important;
  color:#ffffff !important;
}
.loading-message{
  position:fixed;top:44%;left:50%;transform:translate(-50%,-50%);
  background:#0f3c1e;color:#eaffea;border:1px solid rgba(255,255,255,.35);
  border-radius:14px;padding:16px 18px;text-align:center;font-size:clamp(18px,5vw,24px);
  display:none;box-shadow:0 12px 30px rgba(0,0,0,.35);z-index:40;
}

/* Overlay + Modal (robusto en webviews) */
.ov{
  position:fixed; inset:0;
  background:rgba(0,0,0,.4);
  backdrop-filter:saturate(120%) blur(2px);
  z-index: 9000;
  display:none;
  align-items:center;
  justify-content:center;
}
.ov.show{ display:flex; }
.box{
  display:block;
  min-width:min(92vw,520px);
  max-width:92vw;
  background:#0f3c1e; color:#fff;
  border-radius:20px;
  border:1px solid rgba(255,255,255,.18);
  box-shadow:0 20px 60px rgba(0,0,0,.55);
  padding:20px 18px; text-align:center;
}
.q{margin:0 0 10px 0;font-size:clamp(18px,5vw,22px);font-weight:900}
.actions{display:flex;gap:10px;justify-content:center}
.btn.ok{
  font-weight:900;border:none;border-radius:14px;padding:12px 18px;cursor:pointer;
  background:linear-gradient(90deg,var(--accent1),#a9ffdf);color:#062017;
}
.btn.no{
  font-weight:900;border:none;border-radius:14px;padding:12px 18px;cursor:pointer;
  background:linear-gradient(90deg,#ff6b6b,#ffd0d0);color:#1a0606;
}

@media(max-width:768px){
  header{gap:8px;padding:12px 10px}
  .contact-info{flex-direction:row;flex-wrap:wrap;justify-content:center}
  .search-bar{width:100%}
  .random-button{width:100%}
  #raffles{gap:10px;margin-top:12px}
}
@media(prefers-reduced-motion:reduce){
  *,*::before,*::after{animation:none !important;transition:none !important}
}
  </style>
</head>
<body>
  <div class="top-veil" aria-hidden="true"></div>

  <header>
    <div class="brand">
      <img id="logoImg" src="" alt="Logo" referrerpolicy="no-referrer">
      <h1 id="houseName">Rifas</h1>
    </div>

    <input id="search" class="search-bar" type="tel" inputmode="numeric" pattern="[0-9]*" maxlength="4"
      enterkeyhint="search" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"
      placeholder="Buscar # de boleta…">
    <button class="random-button" id="randomButton"># ALEATORIO</button>

    <div class="contact-info">
      <p id="phone"></p>
      <p id="address"></p>
    </div>
  </header>

  <div id="searchResult" class="search-result"></div>
  <div id="raffles"></div>

  <!-- Overlay + Modal -->
  <div id="ov" class="ov" aria-hidden="true">
    <div id="box" class="box" role="dialog" aria-modal="true">
      <p id="q" class="q"></p>
      <div class="actions">
        <button id="yes" class="btn ok" type="button">Sí</button>
        <button id="no" class="btn no" type="button">No</button>
      </div>
    </div>
  </div>

  <!-- Mensajes -->
  <div id="message" class="message">Boleta ocupada</div>
  <div id="loadingMessage" class="loading-message">Buscando número aleatorio...</div>

  <script>
/*** ======= CONFIG ======= ***/
const KEY = '1MyOkJrGpeY1ZXQVFq_srndALEh6Nzzir8sFSfu-0EVM';
const GID_RAFFLES = '1661037065';     // Hoja: Numero_De_Rifas (A=Numero, B=Asignado/Libre)
const GID_CONFIG  = '856149436';      // Hoja: Config_Publica
const PROXY = 'https://csv-proxy.jeisendigital.workers.dev/?u='; // tu Worker

/*** ======= CSV endpoints (fallback) ======= ***/
const csvUrls = (gid) => {
  const ts = Date.now();
  return [
    `https://docs.google.com/spreadsheets/d/${KEY}/export?format=csv&gid=${gid}&_=${ts}`,
    `https://docs.google.com/spreadsheets/d/${KEY}/gviz/tq?tqx=out:csv&gid=${gid}&_=${ts}`,
  ];
};
const fetchText = async (url) => {
  const res = await fetch(PROXY + encodeURIComponent(url), {cache:'no-store', credentials:'omit'});
  if(!res.ok) throw new Error('HTTP '+res.status);
  return res.text();
};
async function fetchCsvAny(gid){
  const urls = csvUrls(gid);
  let lastErr = null, txt = '';
  for (const u of urls){
    try{ txt = await fetchText(u); if (txt && !txt.trimStart().startsWith('<')) return txt; } 
    catch(e){ lastErr = e; }
  }
  if (txt) return txt;
  throw lastErr || new Error('No se pudo obtener CSV');
}

/*** ======= Estado global ======= ***/
let ALL = {};             // { "0000": "libre" | "ocupado" }
let DAILY = [];           // hasta 400 libres del día (estable)
let SEARCH_INPUT = null;
let GRID_TIMER = null;
let MAP_TIMER = null;
let MODAL_OPEN = false;
let DAY_MARK = null;      // YYYY-MM-DD del último sorteo diario

/*** ======= Utilidades ======= */
const pad4 = n => String(n).replace(/\D/g,'').slice(0,4).padStart(4,'0');
const todayKey = () => new Date().toISOString().slice(0,10); // YYYY-MM-DD
function randInt(maxExclusive){
  if (window.crypto && window.crypto.getRandomValues){
    const b = new Uint32Array(1);
    window.crypto.getRandomValues(b);
    return b[0] % maxExclusive;
  }
  return Math.floor(Math.random()*maxExclusive);
}
function msg(text, error=false){
  const el = document.getElementById('message');
  if (!el) return;
  el.textContent = text || '';
  el.classList.toggle('error', !!error);
  el.style.display = 'block';
  clearTimeout(msg._t);
  msg._t = setTimeout(()=>{ el.style.display = 'none'; }, error ? 2600 : 1400);
}
// CSV-parser
function parseCSV(text){
  if (text.trimStart().startsWith('<')) return [];
  const rows = [];
  let i=0, cur='', inQ=false;
  const push = ()=>{ rows[rows.length-1].push(cur); cur=''; };
  rows.push([]);
  while (i<text.length){
    const c=text[i];
    if (inQ){
      if (c === '"'){
        if (text[i+1] === '"'){ cur+='"'; i++; }
        else inQ=false;
      } else cur+=c;
    }else{
      if (c === '"'){ inQ=true; }
      else if (c === ','){ push(); }
      else if (c === '\n'){ push(); rows.push([]); }
      else if (c === '\r'){ /* skip */ }
      else cur+=c;
    }
    i++;
  }
  push();
  return rows.filter(r => r.some(x=>String(x).trim()!=='')); 
}

/*** ======= Base 0000–9999 (ocupado por defecto) ======= */
function makeBaseMap(){
  const map = {};
  for (let i=0;i<10000;i++){
    map[String(i).padStart(4,'0')] = 'ocupado';
  }
  return map;
}

/*** ======= Normalización (solo col B) ======= */
// Columna B: "Libre" o "Asignado". Vacío => OCUPADO (porque dices que B siempre pone uno de esos)
function normStatusAB(s){
  const t = String(s ?? '').trim().toLowerCase();
  if (t === 'libre') return 'libre';
  return 'ocupado'; // asignado o vacío = ocupado
}

/*** ======= UI helpers ======= */
function confirmNum(n){
  const ov  = document.getElementById("ov");
  const box = document.getElementById("box");
  const yes = document.getElementById("yes");
  const no  = document.getElementById("no");
  const q   = document.getElementById("q");
  if(!ov || !box || !yes || !no || !q){ return; }
  MODAL_OPEN = true;
  q.textContent = "¿Quieres separar este número? " + n;
  box.style.display = "block";
  ov.classList.add("show");
  ov.setAttribute("aria-hidden","false");
  yes.onclick = (e)=>{ e.preventDefault(); e.stopPropagation(); closeBox(); openWA(n); };
  no.onclick  = (e)=>{ e.preventDefault(); e.stopPropagation(); closeBox(); };
  ov.onclick  = ()=> closeBox();
  box.onclick = (e)=> e.stopPropagation();
  setTimeout(()=>{ try{ yes.focus(); }catch(_){} }, 0);
}
function closeBox(){
  const ov  = document.getElementById("ov");
  const box = document.getElementById("box");
  MODAL_OPEN = false;
  if(ov){ ov.classList.remove("show"); ov.setAttribute("aria-hidden","true"); }
  if(box){ box.style.display = "block"; }
}
function openWA(number){
  const tel = (window.__CONFIG_PHONE || '').replace(/\D/g,'') || '573206413635';
  const message = "Hola, estoy interesado en separar este número: " + number;
  const url = "https://api.whatsapp.com/send?phone=" + tel + "&text=" + encodeURIComponent(message);
  const w = window.open(url, '_blank'); if (!w){ location.href = url; }
}
function makeTile(num, large){
  const el = document.createElement('div');
  el.className = 'raffle' + (large ? ' large-raffle' : '');
  el.innerHTML = `<span>${num}</span>`;
  el.addEventListener('click', ()=> confirmNum(num), {passive:true});
  el.addEventListener('pointerdown', ()=>{}, {passive:true});
  return el;
}
function renderGrid(){
  const wrap = document.getElementById('raffles');
  if (!wrap) return;
  if (document.body.classList.contains('search-has-text') || MODAL_OPEN) return;
  wrap.innerHTML = '';
  DAILY.forEach(n => wrap.appendChild(makeTile(n, false)));
}
function renderSearchOne(num){
  const layer = document.getElementById('searchResult');
  layer.style.display = 'none';
  layer.innerHTML = '';
  if (!num) return;
  layer.appendChild(makeTile(num, true));
  layer.style.display = 'flex';
}
function clearSearchLayer(){
  const layer = document.getElementById('searchResult');
  layer.style.display = 'none';
  layer.innerHTML = '';
}

/*** ======= Carga de CONFIG ======= */
async function loadConfig(){
  try{
    const txt = await fetchCsvAny(GID_CONFIG);
    const rows = parseCSV(txt);
    if(rows.length < 2) return;
    const head = rows[0]; const data = rows[1];
    const hIdx = (name) => head.findIndex(h => String(h).trim().toLowerCase() === name.toLowerCase());

    const name = data[hIdx('Nombre_APP')] || data[hIdx('Nombre_De_La_Rifa')] || 'Rifas';
    const phone = data[hIdx('Telefonos')] || '';
    const address = data[hIdx('Direccion')] || '';
    const logo = data[hIdx('Logo')] || '';

    document.getElementById('houseName').textContent = String(name || '').trim();
    document.getElementById('phone').textContent = phone ? ('Tel: ' + phone) : '';
    document.getElementById('address').textContent = address ? ('Dir: ' + address) : '';
    document.getElementById('logoImg').src = String(logo || '').trim();
    window.__CONFIG_PHONE = phone || '';
  }catch(e){ console.warn('Config error', e); }
}

/*** ======= Persistencia/Selección diaria ======= */
function persistDaily(){
  const key = 'daily_' + todayKey();
  try { localStorage.setItem(key, JSON.stringify(DAILY || [])); } catch(_){}
}
function loadDailyFromCache(){
  const key = 'daily_' + todayKey();
  try{
    const cached = JSON.parse(localStorage.getItem(key) || '[]');
    if (Array.isArray(cached) && cached.length){
      DAILY = cached.filter(n => ALL[n] === 'libre'); // solo mantener los que sigan libres
      persistDaily();
      return DAILY.length > 0;
    }
  }catch(_){}
  return false;
}
function pickDaily(force=false){
  // Si no hay force e intentamos desde cache
  if (!force && loadDailyFromCache()) return;

  const libres = Object.keys(ALL || {}).filter(k => ALL[k] === 'libre');
  // Fisher–Yates con aleatoriedad fuerte
  for (let i=libres.length-1;i>0;i--){
    const j = randInt(i+1);
    [libres[i],libres[j]] = [libres[j],libres[i]];
  }
  DAILY = libres.slice(0, 400);
  persistDaily();
}

/*** ======= Carga MAPA (solo columnas A/B) ======= */
async function syncMap(){
  try{
    const txt = await fetchCsvAny(GID_RAFFLES);
    const rows = parseCSV(txt);
    if(rows.length < 2){ console.warn('No hay filas'); return; }

    // Base ocupado
    const map = makeBaseMap();

    // Solo A/B: A = número, B = estado (Asignado/Libre)
    for (let i=1;i<rows.length;i++){
      const r = rows[i] || [];
      const a = (r[0] ?? '').toString().trim(); // Col A
      const b = (r[1] ?? '').toString().trim(); // Col B
      if (!a) continue;

      let digits = a.replace(/\D/g,'');
      if (!digits) continue;
      if (digits.length > 4) digits = digits.slice(0,4);
      const num = digits.padStart(4,'0');

      map[num] = normStatusAB(b); // Libre/Asignado -> libre/ocupado
    }

    ALL = map;

    // Mantener DAILY estable: solo quitar los que se hayan ocupado
    const before = DAILY.length;
    DAILY = (DAILY || []).filter(n => ALL[n] === 'libre');
    if (DAILY.length !== before) persistDaily();

  }catch(e){ console.warn('syncMap error', e); }
}

/*** ======= Buscar exacto ======= */
async function rerenderSearch(){
  const layer = document.getElementById('searchResult');
  const raw = (SEARCH_INPUT.value || '').replace(/\D/g,'').slice(0,4);
  if (SEARCH_INPUT.value !== raw) SEARCH_INPUT.value = raw;

  layer.style.display = 'none';
  layer.innerHTML = '';

  if (raw.length === 0){
    document.body.classList.remove('search-has-text');
    return;
  }
  document.body.classList.add('search-has-text');

  if (!ALL || !Object.keys(ALL).length){
    await syncMap();
    if (!ALL || !Object.keys(ALL).length){ msg('Sin conexión o datos.', true); return; }
  }

  const padded = pad4(raw); // 7 -> 0007
  const st = ALL[padded] || 'ocupado';

  if (st === 'libre'){
    renderSearchOne(padded);
  }else{
    // Mostrar explícitamente OCUPADA aunque no se muestre tarjeta
    clearSearchLayer();
    msg('Boleta ocupada', true);
  }
}

/*** ======= Init ======= */
document.addEventListener('DOMContentLoaded', async ()=>{
  function applyViewportOffset(){
    var top = 0;
    if (window.visualViewport){
      top = Math.max(0, Math.round(window.visualViewport.offsetTop || 0));
    }
    document.documentElement.style.setProperty('--vv-top', top + 'px');
    updateHeaderPadding();
  }
  function updateHeaderPadding(){
    var header = document.querySelector('header');
    if(!header) return;
    var h = Math.max(70, Math.round(header.getBoundingClientRect().height));
    document.documentElement.style.setProperty('--header-h', h + 'px');
  }

  SEARCH_INPUT = document.getElementById('search');
  function instantFocus(e){
    if (document.activeElement !== SEARCH_INPUT) {
      e.preventDefault();
      SEARCH_INPUT.focus({preventScroll:true});
      setTimeout(()=>{
        try{ 
          var len = SEARCH_INPUT.value.length;
          SEARCH_INPUT.setSelectionRange(len, len);
        }catch(_){}
      }, 0);
    }
  }
  SEARCH_INPUT.addEventListener('pointerdown', instantFocus, {passive:false});
  SEARCH_INPUT.addEventListener('touchstart', instantFocus, {passive:false});
  SEARCH_INPUT.addEventListener('click', function(){
    if (document.activeElement !== SEARCH_INPUT) SEARCH_INPUT.focus({preventScroll:true});
  }, {passive:true});
  SEARCH_INPUT.addEventListener('input', () => { rerenderSearch(); });
  SEARCH_INPUT.addEventListener('blur', function(){
    if (!MODAL_OPEN && SEARCH_INPUT.value.trim().length === 0){
      document.body.classList.remove('search-has-text');
      clearSearchLayer();
    }
  });

  // Botón ALEATORIO: libre global si existe; si no, cualquiera 0000–9999
  document.getElementById('randomButton').addEventListener('click', async function() {
    const loading = document.getElementById('loadingMessage');
    const layer = document.getElementById('searchResult');

    loading.style.display = 'block';
    layer.style.display = 'none';
    layer.innerHTML = '';
    // ocultar cualquier msg previo
    const m = document.getElementById('message'); if (m) m.style.display = 'none';

    if (!ALL || !Object.keys(ALL).length){ await syncMap(); }

    let chosen = null;
    const libres = Object.keys(ALL || {}).filter(k => ALL[k] === 'libre');

    if (libres.length){
      chosen = libres[randInt(libres.length)];
    }else{
      chosen = String(randInt(10000)).padStart(4,'0');
    }

    SEARCH_INPUT.value = String(parseInt(chosen, 10));
    document.body.classList.add('search-has-text');

    const st = ALL[chosen] || 'ocupado';
    if (st === 'libre'){
      renderSearchOne(chosen);
    }else{
      clearSearchLayer();
      msg('Boleta ocupada', true);
    }

    setTimeout(()=>{ loading.style.display = 'none'; }, 300);
  }, {passive:true});

  // Layout
  updateHeaderPadding();
  applyViewportOffset();
  if (window.visualViewport){
    visualViewport.addEventListener('resize', ()=> requestAnimationFrame(applyViewportOffset));
    visualViewport.addEventListener('scroll', ()=> requestAnimationFrame(applyViewportOffset));
  }
  window.addEventListener('resize', ()=> requestAnimationFrame(applyViewportOffset), {passive:true});

  // Carga inicial
  DAY_MARK = todayKey();
  await loadConfig();
  await syncMap();
  pickDaily(true); // sorteo inicial del día (estable)
  renderGrid();

  // Timers (cada 5s)
  GRID_TIMER = setInterval(()=> renderGrid(), 5000);

  MAP_TIMER  = setInterval(async ()=>{
    // 1) si cambió el día -> nuevo sorteo
    const nowKey = todayKey();
    if (nowKey !== DAY_MARK){
      DAY_MARK = nowKey;
      await syncMap();       // refresca estados
      DAILY = [];            // invalida diario viejo
      pickDaily(true);       // NUEVO sorteo del día
      renderGrid();
      return;
    }

    // 2) mismo día: solo actualizar estados y encoger DAILY si se ocuparon
    const before = DAILY.length;
    await syncMap();
    if (DAILY.length !== before){
      renderGrid();          // muestra menos si algunos se ocuparon
    }
  }, 5000);
});
  </script>
</body>
</html>
