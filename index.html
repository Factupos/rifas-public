<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Boletas de Rifa</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, interactive-widget=overlays-content">
    <style>
:root{--bg:#129a3a;--bg-deep:#0e7f30;--ink:#ffffff;--muted:#e5ffe8;--a1:#00ffa9;--a2:#3db7ff;--a3:#ffb24d;--header-h:90px}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%}
body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--ink);background:var(--bg);line-height:1.2;padding-top:calc(var(--header-h)+10px);overscroll-behavior-y:contain;touch-action:manipulation}
header{position:fixed;left:0;right:0;top:10px;z-index:30;display:flex;align-items:center;gap:10px;padding:10px 14px;min-height:90px;background:linear-gradient(0deg,rgba(0,0,0,.18),rgba(0,0,0,.18)),var(--bg-deep);border-bottom:1px solid rgba(255,255,255,.12);box-shadow:0 10px 26px rgba(0,0,0,.35)}
header div{display:flex;align-items:center;gap:12px}
#logo{height:56px;width:56px;object-fit:cover;border-radius:50%;border:2px solid rgba(255,255,255,.2);box-shadow:0 0 0 2px rgba(255,255,255,.18),0 0 22px rgba(0,0,0,.25)}
#title{margin:0;font-weight:900;font-size:clamp(18px,3.2vw,24px);letter-spacing:.5px;background:linear-gradient(90deg,#fff,var(--a2) 50%,var(--a1) 90%);-webkit-background-clip:text;background-clip:text;color:transparent}
.meta{display:flex;gap:10px;margin-left:auto}
.meta p{margin:0;font-size:12px;color:var(--muted);font-weight:800;letter-spacing:.2px}
.search{width:92vw;max-width:720px;height:60px;border-radius:20px;border:1px solid rgba(255,255,255,.22);padding:0 16px;font-size:22px;line-height:60px;outline:none;background:#0f3c1e;color:#f6fff7;box-shadow:inset 0 0 0 1px rgba(255,255,255,.15),0 8px 20px rgba(0,0,0,.25);caret-color:#ffffff;-webkit-appearance:none;appearance:none}
.search::placeholder{color:rgba(235,255,240,.8)}
.search:focus{box-shadow:inset 0 0 0 2px var(--a2),0 0 16px rgba(61,183,255,.45)}
.btn{height:40px;border-radius:12px;border:none;padding:0 14px;font-weight:900;cursor:pointer;background:linear-gradient(90deg,var(--a1),#a9ffdf);color:#062017}
.wrap{display:flex;flex-wrap:wrap;justify-content:center;gap:12px;margin:16px auto 28px;max-width:1240px;padding:0 10px 20vh}
.card{--s:clamp(92px,26vw,124px);width:var(--s);height:calc(var(--s) + 16px);border-radius:16px;display:flex;align-items:center;justify-content:center;position:relative;font-weight:900;color:#fff;background:radial-gradient(circle at 50% 28%,rgba(255,255,255,.10) 0 18%,transparent 19%),radial-gradient(circle at 37% 42%,rgba(255,255,255,.10) 0 18%,transparent 19%),radial-gradient(circle at 63% 42%,rgba(255,255,255,.10) 0 18%,transparent 19%),linear-gradient(145deg,transparent 0 62%,rgba(255,255,255,.10) 63%,transparent 64%),linear-gradient(160deg,#0b2b15,#0a2412 60%);box-shadow:inset 0 0 0 1px rgba(255,255,255,.10),0 10px 26px rgba(0,0,0,.35);outline:none;border:none}
.card span{font-size:clamp(38px,8.5vw,48px);text-shadow:0 2px 10px rgba(0,0,0,.45),0 0 18px rgba(255,255,255,.18)}
.card:before{content:"";position:absolute;inset:-1px;border-radius:inherit;padding:6px;background:conic-gradient(from 180deg at 50% 50%,var(--a1),var(--a2),var(--a3),var(--a1));-webkit-mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);-webkit-mask-composite:xor;mask-composite:exclude;opacity:.95}
.big{--s:clamp(160px,52vw,200px);height:calc(var(--s) + 18px)}
.big span{font-size:clamp(50px,12vw,70px)}
.msg{padding:14px 16px;background:rgba(255,255,255,.12);color:#fff;border:1px solid rgba(255,255,255,.45);border-radius:14px;width:min(92vw,420px);text-align:center;font-size:clamp(16px,4.8vw,22px);font-weight:900;display:none;position:fixed;top:calc(var(--header-h) + 10px);left:50%;transform:translateX(-50%);z-index:60;box-shadow:0 12px 30px rgba(0,0,0,.35)}
.msg.error{background:#ff3b30;border-color:#ffd0d0;color:#fff}
.layer{position:fixed;top:calc(var(--header-h) + 12px);left:50%;transform:translateX(-50%);z-index:55;display:none;width:min(92vw,720px);pointer-events:auto;display:flex;flex-wrap:wrap;justify-content:center;gap:12px}
.ov{position:fixed;inset:0;background:rgba(0,0,0,.38);z-index:64;display:none}
.box{padding:28px;background:#0f3c1e;color:#ffffff;border-radius:20px;width:min(92vw,620px);text-align:center;font-size:clamp(18px,5vw,24px);font-weight:900;display:none;position:fixed;top:calc(var(--header-h) + 10px);left:50%;transform:translateX(-50%);z-index:65;box-shadow:0 20px 60px rgba(0,0,0,.55);border:1px solid rgba(255,255,255,.18)}
.box:before{content:"";position:absolute;inset:-2px;border-radius:inherit;padding:5px;background:conic-gradient(from 180deg at 50% 50%,var(--a2),var(--a1),var(--a3),var(--a2));-webkit-mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);-webkit-mask-composite:xor;mask-composite:exclude;opacity:.95}
.actions{display:flex;gap:10px;justify-content:center;margin-top:12px}
.ok{background:linear-gradient(90deg,var(--a1),#a9ffdf);color:#062017}
.no{background:linear-gradient(90deg,#ff6b6b,#ffd0d0);color:#1a0606}
@media(max-width:768px){header{flex-direction:column;gap:8px;padding:12px 10px}.search{width:92vw;max-width:92vw}.wrap{gap:10px;margin-top:12px}}
    </style>
  </head>
  <body>
    <header>
      <div>
        <img id="logo" alt="Logo">
        <h1 id="title"></h1>
      </div>
      <input id="search" class="search" type="tel" inputmode="numeric" pattern="[0-9]*" maxlength="4" enterkeyhint="search" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Buscar # de boleta…">
      <button id="btnRnd" class="btn">#ALEATORIO</button>
      <div class="meta">
        <p id="phone"></p>
        <p id="addr"></p>
      </div>
    </header>

    <div id="layer" class="layer"></div>
    <div id="grid" class="wrap"></div>

    <div id="msg" class="msg"></div>

    <div id="ov" class="ov"></div>
    <div id="box" class="box">
      <p id="q"></p>
      <div class="actions">
        <button id="yes" class="btn ok">Sí</button>
        <button id="no" class="btn no">No</button>
      </div>
    </div>

    <script>
/* === TUS URLs públicas (ya colocadas) === */
const CSV_URL_RAFFLES = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSpEYmEB2HJGN2F3xokfLIvpbfGA70it6YSneM8MKc0flcXn7NfZwKgmTC3x2N8oOH1krkkJyOiakru/pub?gid=1661037065&single=true&output=csv";
const CSV_URL_CONFIG  = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSpEYmEB2HJGN2F3xokfLIvpbfGA70it6YSneM8MKc0flcXn7NfZwKgmTC3x2N8oOH1krkkJyOiakru/pub?gid=856149436&single=true&output=csv";

/* Número WhatsApp por defecto (si el CSV no trae uno válido) */
const DEFAULT_WA_PHONE = "+573206413635";

/* === Utilidades CSV y red === */
function bust(u){return u+(u.includes("?")?"&":"?")+"t="+Date.now()}
function parseCSV(raw){return raw.trim().split(/\r?\n/).map(r=>r.split(","))}
async function getCSV(url){const r=await fetch(bust(url),{cache:"no-store",credentials:"omit"});return await r.text()}

/* === Estado en memoria === */
let allMap = {};   // { "0001":"libre"/"ocupado", ... }
let current = [];  // arreglo de libres aleatorios para el grid
let waPhone = DEFAULT_WA_PHONE;

/* === UI helpers === */
function showMsg(t,err){const m=document.getElementById("msg");m.textContent=t||"";m.classList.toggle("error",!!err);m.style.display="block";clearTimeout(showMsg._t);showMsg._t=setTimeout(()=>m.style.display="none", err?2500:1200)}
function card(num,big){const d=document.createElement("div");d.className="card"+(big?" big":"");d.innerHTML="<span>"+num+"</span>";d.addEventListener("click",()=>confirmNum(num));return d}
function renderGrid(list){const g=document.getElementById("grid");g.innerHTML="";list.forEach(n=>g.appendChild(card(n,false)))}
function renderSearch(list,exact){const l=document.getElementById("layer");l.style.display="none";l.innerHTML="";if(!list||!list.length)return;list.forEach(n=>l.appendChild(card(n,!!exact)));l.style.display="flex"}

/* === Confirmación + WhatsApp === */
function confirmNum(n){const ov=document.getElementById("ov");const b=document.getElementById("box");document.getElementById("q").textContent="¿Quieres separar este número? "+n;ov.style.display="block";b.style.display="block";document.getElementById("yes").onclick=()=>{closeBox();openWA(n)};document.getElementById("no").onclick=closeBox}
function closeBox(){document.getElementById("ov").style.display="none";document.getElementById("box").style.display="none"}
function normPhone(p){const d=(p||"").replace(/\D/g,"");if(!d) return DEFAULT_WA_PHONE; if(d.startsWith("57")) return "+"+d; if(d.length===10) return "+57"+d; return "+"+d}
function openWA(n){const msg="Hola, estoy interesado en separar este número: "+n;const url="https://api.whatsapp.com/send?phone="+encodeURIComponent(waPhone)+"&text="+encodeURIComponent(msg);window.open(url,"_blank")}

/* === Carga Config (por encabezado) === */
async function loadConfig(){
  try{
    const raw = await getCSV(CSV_URL_CONFIG);
    const rows = parseCSV(raw);
    if (!rows || rows.length < 2) return;
    const headers = rows[0];
    const values  = rows[1];

    const cfg = {};
    for (let i = 0; i < headers.length; i++){
      const key = (headers[i] || "").toString().trim();
      if (!key) continue;
      cfg[key] = (values[i] || "").toString();
    }

    const name    = cfg["Nombre_De_La_Rifa"] || cfg["Nombre"] || cfg["Nombre_Comercial"] || "";
    const phone   = cfg["Telefonos"] || cfg["Telefono"] || cfg["Teléfono"] || "";
    const address = cfg["Direccion"] || cfg["Dirección"] || "";
    const logoUrl = cfg["Logo"] || "";

    document.getElementById("title").textContent = name;
    document.getElementById("phone").textContent = phone ? ("Tel: " + phone) : "";
    document.getElementById("addr").textContent  = address ? ("Dir: " + address) : "";
    if (logoUrl) document.getElementById("logo").src = logoUrl;

    waPhone = normPhone(phone) || DEFAULT_WA_PHONE;

  }catch(e){
    // silencio en caso de fallo
  }
}

/* === Sincroniza el mapa de rifas y genera grid === */
async function syncMap(){
  try{
    const t = await getCSV(CSV_URL_RAFFLES);
    const rows = parseCSV(t);
    const map = {}; const free = [];
    for (let i=0;i<rows.length;i++){
      const num = (rows[i][0]||"").toString().padStart(4,"0");
      const st  = (rows[i][1]||"").toString().toLowerCase();
      if(!num) continue;
      map[num] = st;
      if (st === "libre") free.push(num);
    }
    allMap = map;
    current = pickRandom(free, 400);
    if(!document.body.classList.contains("has-text")) renderGrid(current);
  }catch(e){
    showMsg("Error de conexión", true);
  }
}
function pickRandom(arr,n){const a=arr.slice();for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a.slice(0,Math.min(n,a.length))}

/* === Buscador === */
function rerenderSearch(){
  const el=document.getElementById("search");
  const raw=(el.value||"").replace(/\D/g,"").slice(0,4);
  if(el.value!==raw) el.value=raw;

  const layer=document.getElementById("layer");
  layer.style.display="none";layer.innerHTML="";

  if(raw.length===0){document.body.classList.remove("has-text");return}
  document.body.classList.add("has-text");

  const padded=raw.padStart(4,"0");
  if(typeof allMap[padded]==="undefined"){showMsg("Verificando…");return}
  if(allMap[padded]==="libre"){renderSearch([padded],true)}else{showMsg("Boleta ocupada",true)}
}

/* === Init === */
document.addEventListener("DOMContentLoaded",()=>{
  const s=document.getElementById("search");
  s.addEventListener("input",e=>{const v=e.target.value.replace(/\D/g,"").slice(0,4);if(e.target.value!==v)e.target.value=v;rerenderSearch()});
  document.getElementById("btnRnd").addEventListener("click",()=>{
    const keys=Object.keys(allMap).filter(k=>allMap[k]==="libre");
    if(!keys.length){showMsg("No hay boletas libres");return}
    const rnd=keys[Math.floor(Math.random()*keys.length)];
    s.value=parseInt(rnd,10).toString();document.body.classList.add("has-text");renderSearch([rnd],true);
  });
  document.getElementById("ov").addEventListener("click",()=>{closeBox()});

  loadConfig();
  syncMap();
  setInterval(syncMap, 5000);
});
    </script>
  </body>
</html>
