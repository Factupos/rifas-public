<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Boletas de Rifa</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, interactive-widget=overlays-content">
  <link rel="icon" href="data:,">
  <style>
:root{--bg:#129a3a;--bg-deep:#0e7f30;--ink:#fff;--muted:#e5ffe8;--a1:#00ffa9;--a2:#3db7ff;--a3:#ffb24d;--header-h:90px}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}html,body{height:100%}
body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--ink);background:var(--bg);line-height:1.2;padding-top:calc(var(--header-h)+10px);overscroll-behavior-y:contain;touch-action:manipulation}
header{position:fixed;left:0;right:0;top:10px;z-index:30;display:flex;align-items:center;gap:10px;padding:10px 14px;min-height:90px;background:linear-gradient(0deg,rgba(0,0,0,.18),rgba(0,0,0,.18)),var(--bg-deep);border-bottom:1px solid rgba(255,255,255,.12);box-shadow:0 10px 26px rgba(0,0,0,.35)}
header div{display:flex;align-items:center;gap:12px}
#logo{height:56px;width:56px;object-fit:cover;border-radius:50%;border:2px solid rgba(255,255,255,.2);box-shadow:0 0 0 2px rgba(255,255,255,.18),0 0 22px rgba(0,0,0,.25)}
#title{margin:0;font-weight:900;font-size:clamp(18px,3.2vw,24px);letter-spacing:.5px;background:linear-gradient(90deg,#fff,var(--a2) 50%,var(--a1) 90%);-webkit-background-clip:text;background-clip:text;color:transparent}
.meta{display:flex;gap:10px;margin-left:auto}.meta p{margin:0;font-size:12px;color:var(--muted);font-weight:800;letter-spacing:.2px}
.search{width:92vw;max-width:720px;height:60px;border-radius:20px;border:1px solid rgba(255,255,255,.22);padding:0 16px;font-size:22px;line-height:60px;outline:none;background:#0f3c1e;color:#f6fff7;box-shadow:inset 0 0 0 1px rgba(255,255,255,.15),0 8px 20px rgba(0,0,0,.25)}
.search::placeholder{color:rgba(235,255,240,.8)}.search:focus{box-shadow:inset 0 0 0 2px var(--a2),0 0 16px rgba(61,183,255,.45)}
.btn{height:40px;border-radius:12px;border:none;padding:0 14px;font-weight:900;cursor:pointer;background:linear-gradient(90deg,var(--a1),#a9ffdf);color:#062017}
.wrap{display:flex;flex-wrap:wrap;justify-content:center;gap:12px;margin:16px auto 28px;max-width:1240px;padding:0 10px 20vh}
.card{--s:clamp(92px,26vw,124px);width:var(--s);height:calc(var(--s)+22px);border-radius:16px;display:flex;flex-direction:column;align-items:center;justify-content:center;position:relative;font-weight:900;color:#fff;background:radial-gradient(circle at 50% 28%,rgba(255,255,255,.10) 0 18%,transparent 19%),radial-gradient(circle at 37% 42%,rgba(255,255,255,.10) 0 18%,transparent 19%),radial-gradient(circle at 63% 42%,rgba(255,255,255,.10) 0 18%,transparent 19%),linear-gradient(145deg,transparent 0 62%,rgba(255,255,255,.10) 63%,transparent 64%),linear-gradient(160deg,#0b2b15,#0a2412 60%);box-shadow:inset 0 0 0 1px rgba(255,255,255,.10),0 10px 26px rgba(0,0,0,.35)}
.card span.num{font-size:clamp(36px,8.5vw,46px);text-shadow:0 2px 10px rgba(0,0,0,.45),0 0 18px rgba(255,255,255,.18)}
.card .st{margin-top:6px;font-size:11px;font-weight:800;padding:3px 8px;border-radius:999px;background:rgba(255,255,255,.16);border:1px solid rgba(255,255,255,.28)}
.card.free .st{background:rgba(0,255,169,.18);border-color:rgba(0,255,169,.45)}
.card.busy .st{background:rgba(255,107,107,.18);border-color:rgba(255,107,107,.45)}
.msg{padding:14px 16px;background:rgba(255,255,255,.12);color:#fff;border:1px solid rgba(255,255,255,.45);border-radius:14px;width:min(92vw,520px);text-align:center;font-size:clamp(16px,4.8vw,22px);font-weight:900;display:none;position:fixed;top:calc(var(--header-h)+10px);left:50%;transform:translateX(-50%);z-index:60;box-shadow:0 12px 30px rgba(0,0,0,.35)}
.msg.error{background:#ff3b30;border-color:#ffd0d0}
.layer{position:fixed;top:calc(var(--header-h)+12px);left:50%;transform:translateX(-50%);z-index:55;display:none;width:min(92vw,720px);display:flex;flex-wrap:wrap;justify-content:center;gap:12px}
.ov{position:fixed;inset:0;background:rgba(0,0,0,.38);z-index:64;display:none}
.box{padding:28px;background:#0f3c1e;color:#fff;border-radius:20px;width:min(92vw,620px);text-align:center;font-size:clamp(18px,5vw,24px);font-weight:900;display:none;position:fixed;top:calc(var(--header-h)+10px);left:50%;z-index:65;box-shadow:0 20px 60px rgba(0,0,0,.55);border:1px solid rgba(255,255,255,.18)}
.actions{display:flex;gap:10px;justify-content:center;margin-top:12px}
.ok{background:linear-gradient(90deg,var(--a1),#a9ffdf);color:#062017}
.no{background:linear-gradient(90deg,#ff6b6b,#ffd0d0);color:#1a0606}
.legend{display:flex;gap:8px;align-items:center;justify-content:center;margin-top:6px;font-size:12px;color:#eaffea}
.dot{display:inline-block;width:10px;height:10px;border-radius:50%}
.dot.free{background:#69f0ae}.dot.busy{background:#ff8a80}
@media(max-width:768px){header{flex-direction:column;gap:8px;padding:12px 10px}.search{width:92vw;max-width:92vw}.wrap{gap:10px;margin-top:12px}}
#debug{position:fixed;right:8px;bottom:8px;max-width:96vw;max-height:60vh;overflow:auto;background:rgba(0,0,0,.85);color:#fff;padding:12px 14px;border-radius:12px;font:12px/1.45 ui-monospace,Menlo,Consolas,monospace;z-index:99999;white-space:pre-wrap;display:none;border:1px solid rgba(255,255,255,.25);box-shadow:0 8px 30px rgba(0,0,0,.55)}
  </style>
</head>
<body>
  <header>
    <div>
      <img id="logo" alt="Logo">
      <h1 id="title"></h1>
    </div>
    <input id="search" class="search" type="tel" inputmode="numeric" pattern="[0-9]*" maxlength="4" placeholder="Buscar # de boleta…">
    <button id="btnRnd" class="btn">#ALEATORIO</button>
    <div class="meta"><p id="phone"></p><p id="addr"></p></div>
  </header>

  <div class="legend"><span class="dot free"></span> Libre <span style="width:10px"></span><span class="dot busy"></span> No libre</div>
  <div id="layer" class="layer"></div>
  <div id="grid" class="wrap"></div>
  <div id="msg" class="msg"></div>

  <div id="ov" class="ov"></div>
  <div id="box" class="box">
    <p id="q"></p>
    <div class="actions">
      <button id="yes" class="btn ok">Sí</button>
      <button id="no" class="btn no">No</button>
    </div>
  </div>

  <div id="debug"></div>

  <script>
/* ================== CONSTANTES ================== */
const PROXY = "https://csv-proxy.jeisendigital.workers.dev";
const SPREADSHEET_ID = "1MyOkJrGpeY1ZXQVFq_srndALEh6Nzzir8sFSfu-0EVM";
const GID_RAFFLES    = "1661037065";  // Numero_De_Rifas
const GID_CONFIG     = "856149436";   // Config_Publica (ajusta si cambia)
const URL_TSV_RAFFLES  = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/export?format=tsv&gid=${GID_RAFFLES}`;
const URL_CSV_RAFFLES  = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/export?format=csv&gid=${GID_RAFFLES}`;
const URL_GVIZ_RAFFLES = `https://docs.google.com/spreadsheets/d/e/2PACX-1vSpEYmEB2HJGN2F3xokfLIvpbfGA70it6YSneM8MKc0flcXn7NfZwKgmTC3x2N8oOH1krkkJyOiakru/gviz/tq?tqx=out:tsv&gid=${GID_RAFFLES}`;
const URL_TSV_CONFIG   = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/export?format=tsv&gid=${GID_CONFIG}`;
const CSV_URL_RAFFLES_TSV  = PROXY + "?u=" + encodeURIComponent(URL_TSV_RAFFLES);
const CSV_URL_RAFFLES_CSV  = PROXY + "?u=" + encodeURIComponent(URL_CSV_RAFFLES);
const CSV_URL_RAFFLES_GVIZ = PROXY + "?u=" + encodeURIComponent(URL_GVIZ_RAFFLES);
const CSV_URL_CONFIG       = PROXY + "?u=" + encodeURIComponent(URL_TSV_CONFIG);
const DEFAULT_WA_PHONE = "+573206413635";

/* ================== DEBUG ================== */
const DEBUG = new URL(location.href).searchParams.get('debug') === '1';
const $dbg = document.getElementById('debug');
function dbg(){ if(!DEBUG) return; $dbg.style.display='block'; $dbg.textContent += Array.from(arguments).map(x=>typeof x==='string'?x:JSON.stringify(x)).join(' ') + "\n"; }

/* ================== UTILES ================== */
function bust(u){return u+(u.includes("?")?"&":"?")+"t="+Date.now()}
async function getText(url){ const r=await fetch(bust(url),{cache:"no-store",credentials:"omit"}); return await r.text(); }
function parseSmart(raw){
  const split=(s)=> (s||'').split(/\r\n|\n|\r/);
  const fast=(s,d)=> split(s).map(l=>l.split(d));
  function quoted(s,d){
    if (!s) return [];
    if (s.charCodeAt(0)===0xFEFF) s=s.slice(1);
    const rows=[]; let row=[],f='',q=false;
    for(let i=0;i<s.length;i++){
      const c=s[i],n=s[i+1];
      if(q){ if(c==='"'){ if(n==='"'){ f+='"'; i++; } else q=false; } else f+=c; }
      else{ if(c==='"') q=true; else if(c===d){ row.push(f); f=''; } else if(c==='\n'){ row.push(f); rows.push(row); row=[]; f=''; }
      else if(c==='\r'){ row.push(f); rows.push(row); row=[]; f=''; if(n==='\n') i++; } else f+=c; }
    } row.push(f); rows.push(row); return rows;
  }
  const cand=[['\t','fast-TSV',fast],['\t','quoted-TSV',quoted],[',','fast-CSV',fast],[',','quoted-CSV',quoted],[';','fast-SCSV',fast],[';','quoted-SCSV',quoted]].map(([d,n,f])=>({rows:f(raw,d).filter(r=>r.some(v=>(v??'').toString().trim()!=='')),delim:d,name:n}));
  let best=cand.reduce((a,b)=>b.rows.length>a.rows.length?b:a,cand[0]);
  if(best.rows.length===1){
    const line=raw.split(/\r\n|\n|\r/)[0]||raw, counts={tab:(line.match(/\t/g)||[]).length,comma:(line.match(/,/g)||[]).length,semi:(line.match(/;/g)||[]).length};
    const k=Object.entries(counts).sort((x,y)=>y[1]-x[1])[0][0]; const d=k==='tab'?'\t':k==='semi'?';':','; const forced=raw.split(/\r\n|\n|\r/).map(l=>l.split(d)).filter(r=>r.some(v=>(v??'').toString().trim()!=='')); if(forced.length>best.rows.length) best={rows:forced,delim:d,name:'forced-'+k};
  }
  dbg('Parser:',best.name,'filas:',best.rows.length);
  return best;
}
function norm(s){return (s||'').toString().trim().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'')}
function normalizeState(v){ let s=(v??'').toString().replace(/\u00A0/g,' ').trim().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,''); return /\b(libre|disponible|free|vacante)\b/.test(s)?'libre':'ocupado'; }
function findColumnIndexes(headers){
  let numIdx=-1,stIdx=-1;
  for(let i=0;i<headers.length;i++){ const h=norm(headers[i]); if(numIdx===-1 && /(numero|n[úu]mero|boleta|ticket|num|#)/.test(h)) numIdx=i; if(stIdx===-1 && /(estado|status|disponible|libre|ocupado|asignado|reservado|vendido|pagado)/.test(h)) stIdx=i; }
  return {numIdx,stIdx};
}
function guessCols(rows){
  const cols=Math.max(...rows.map(r=>r.length)); let bestN=-1,bestNS=-1,bestS=-1,bestSS=-1;
  for(let c=0;c<cols;c++){ let nS=0,sS=0; for(let i=0;i<Math.min(rows.length,1200);i++){ const v=(rows[i][c]||'').toString().trim(); if(/^\d{1,8}$/.test(v)) nS++; const st=normalizeState(v); if(st==='libre'||st==='ocupado') sS++; } if(nS>bestNS){bestNS=nS;bestN=c} if(sS>bestSS){bestSS=sS;bestS=c} }
  return {numIdx:bestN,stIdx:bestS};
}
function todayKey(){ return (new Date()).toDateString(); }

/* ================== CARGA CONFIG ================== */
let waPhone = DEFAULT_WA_PHONE;
async function loadConfig(){
  try{
    const raw=await getText(CSV_URL_CONFIG); const parsed=parseSmart(raw); const rows=parsed.rows;
    if(!rows.length) return;
    let h=-1; for(let i=0;i<rows.length;i++){ if(rows[i].filter(x=>(x||'').trim()!=='').length>=2){h=i;break;} }
    if(h===-1) return;
    const headers=rows[h].map(x=>(x||'').toString().trim());
    let d=-1; for(let j=h+1;j<rows.length;j++){ if(rows[j].filter(x=>(x||'').trim()!=='').length>=1){d=j;break;} }
    if(d===-1) return;
    const vals=rows[d], cfg={}; for(let k=0;k<headers.length;k++){ const key=headers[k]; if(!key) continue; cfg[key]=(vals[k]||'').toString(); }
    const name=cfg["Nombre_De_La_Rifa"]||cfg["Nombre"]||cfg["Nombre_Comercial"]||"";
    const phone=cfg["Telefonos"]||cfg["Telefono"]||cfg["Teléfono"]||"";
    const address=cfg["Direccion"]||cfg["Dirección"]||"";
    const logoUrl=cfg["Logo"]||"";
    document.getElementById("title").textContent=name;
    document.getElementById("phone").textContent=phone?("Tel: "+phone):"";
    document.getElementById("addr").textContent=address?("Dir: "+address):"";
    if(logoUrl) document.getElementById("logo").src=logoUrl;
    const dphone=(phone||"").replace(/\D/g,""); if(dphone) waPhone = dphone.startsWith("57")?("+"+dphone):(dphone.length===10?"+57"+dphone:"+"+dphone);
  }catch(e){ dbg('CONFIG error:',String(e)); }
}

/* ================== CARGA RIFAS ================== */
async function fetchRafflesRawInOrder(){
  const list=[CSV_URL_RAFFLES_TSV, CSV_URL_RAFFLES_CSV, CSV_URL_RAFFLES_GVIZ];
  for(const src of list){
    const txt=await getText(src);
    const t=txt.trim();
    if(t.startsWith('{') && t.includes('"google_returned_html"')){ dbg('Descartado worker JSON error'); continue; }
    if(/<!doctype html|<html/i.test(t)){ dbg('Descartado HTML'); continue; }
    return {raw:txt,src};
  }
  throw new Error('Sin fuente válida (login/HTML).');
}
async function loadRaffles(){
  const {raw}=await fetchRafflesRawInOrder();
  const parsed=parseSmart(raw); const rows=parsed.rows;
  if(!rows.length) return {items:[], map:{}};
  // detectar headers
  let headerRowIdx=-1, headers=[];
  for(let i=0;i<Math.min(5,rows.length);i++){
    const a=(rows[i][0]||'').toString(), b=(rows[i][1]||'').toString();
    const an=norm(a), bn=norm(b);
    const looksHeader=(/[a-z]/.test(an)&&/[a-z]/.test(bn))||
                      /(numero|n[úu]mero|boleta|ticket)/.test(an)||
                      /(estado|status|disponible|libre|ocupado|asignado|reservado|vendido|pagado)/.test(bn);
    if(looksHeader){ headerRowIdx=i; headers=rows[i].map(x=>(x||'').toString()); break; }
  }
  let numIdx=0, stIdx=1, dataStart=0;
  if(headerRowIdx!==-1){ const idxs=findColumnIndexes(headers); if(idxs.numIdx!==-1) numIdx=idxs.numIdx; if(idxs.stIdx!==-1) stIdx=idxs.stIdx; dataStart=headerRowIdx+1; }
  else { const g=guessCols(rows); if(g.numIdx!==-1) numIdx=g.numIdx; if(g.stIdx!==-1) stIdx=g.stIdx; }
  const items=[], map={};
  for(let i=dataStart;i<rows.length;i++){
    let num=(rows[i][numIdx]||'').toString().trim(); if(!num) continue;
    num=num.replace(/\D/g,''); if(!num) continue; num=num.padStart(4,'0');
    const st=normalizeState(rows[i][stIdx]);
    items.push({num, status:st}); map[num]=st;
  }
  items.sort((a,b)=>a.num.localeCompare(b.num));
  return {items, map};
}

/* ================== MODO API (emula Apps Script) ================== */
(async function maybeApiMode(){
  const p=new URL(location.href).searchParams;
  const api=p.get('api');
  if(!api) return; // seguir a UI
  try{
    // build data
    if(api==='config'){
      const raw=await getText(CSV_URL_CONFIG); const parsed=parseSmart(raw); const rows=parsed.rows;
      let out={name:"",phone:"",address:"",logo:""};
      if(rows.length){
        let h=-1; for(let i=0;i<rows.length;i++){ if(rows[i].filter(x=>(x||'').trim()!=='').length>=2){h=i;break;} }
        if(h!==-1){ const headers=rows[h].map(x=>(x||'').toString().trim()); let d=-1; for(let j=h+1;j<rows.length;j++){ if(rows[j].filter(x=>(x||'').trim()!=='').length>=1){d=j;break;} }
          if(d!==-1){ const vals=rows[d], cfg={}; for(let k=0;k<headers.length;k++) cfg[headers[k]]=(vals[k]||'').toString();
            out.name=cfg["Nombre_De_La_Rifa"]||cfg["Nombre"]||cfg["Nombre_Comercial"]||"";
            out.phone=cfg["Telefonos"]||cfg["Telefono"]||"";
            out.address=cfg["Direccion"]||"";
            out.logo=cfg["Logo"]||"";
          }
        }
      }
      document.open(); document.write(JSON.stringify(out)); document.close(); return;
    }
    const {items, map}=await loadRaffles();

    if(api==='allRaffles'){
      document.open(); document.write(JSON.stringify(map)); document.close(); return;
    }

    if(api==='raffleStatus'){
      const n=String(p.get('number')||'').replace(/\D/g,'').slice(0,4).padStart(4,'0');
      const st=map[n]||'ocupado';
      document.open(); document.write(JSON.stringify(st)); document.close(); return;
    }

    if(api==='randomFreeRaffles'){
      const free=items.filter(it=>it.status==='libre').map(it=>it.num);
      const today=todayKey();
      const kR='dailyRaffles', kD='lastUpdate';
      let daily=JSON.parse(localStorage.getItem(kR)||'[]');
      const last=localStorage.getItem(kD)||'';
      function pickRandom(arr, n){
        const a=arr.slice(); for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; }
        return a.slice(0,n);
      }
      if(last!==today || daily.length===0){
        daily = pickRandom(free, 400);
        localStorage.setItem(kR, JSON.stringify(daily));
        localStorage.setItem(kD, today);
      }else{
        daily = daily.filter(x=>free.includes(x));
        localStorage.setItem(kR, JSON.stringify(daily));
      }
      document.open(); document.write(JSON.stringify(daily)); document.close(); return;
    }

    // desconocido
    document.open(); document.write(JSON.stringify({ok:false,error:'unknown_api'})); document.close();
  }catch(err){
    document.open(); document.write(JSON.stringify({ok:false,error:'internal_error',message:String(err)})); document.close();
  }
})();

/* ================== UI (igual comportamiento) ================== */
let allMap={};
function showMsg(t,err){const m=document.getElementById("msg");m.textContent=t||"";m.classList.toggle("error",!!err);m.style.display="block";clearTimeout(showMsg._t);showMsg._t=setTimeout(()=>m.style.display="none",err?2500:1200)}
function card(num,status){const d=document.createElement("div");d.className="card "+(status==='libre'?'free':'busy');d.innerHTML=`<span class="num">${num}</span><span class="st">${status==='libre'?'Libre':'No libre'}</span>`;d.addEventListener("click",()=>confirmNum(num));return d}
function renderGrid(list){const g=document.getElementById("grid");g.innerHTML="";list.forEach(it=>g.appendChild(card(it.num,it.status)))}
function renderSearch(list){const l=document.getElementById("layer");l.style.display="none";l.innerHTML="";if(!list||!list.length)return;list.forEach(n=>l.appendChild(card(n,'libre')));l.style.display="flex"}
function confirmNum(n){const ov=document.getElementById("ov");const b=document.getElementById("box");document.getElementById("q").textContent="¿Quieres separar este número? "+n;ov.style.display="block";b.style.display="block";document.getElementById("yes").onclick=()=>{closeBox();openWA(n)};document.getElementById("no").onclick=closeBox}
function closeBox(){document.getElementById("ov").style.display="none";document.getElementById("box").style.display="none"}
function openWA(n){const msg="Hola, estoy interesado en separar este número: "+n;const url="https://api.whatsapp.com/send?phone="+encodeURIComponent(waPhone)+"&text="+encodeURIComponent(msg);window.open(url,"_blank")}
async function syncAll(){
  try{
    const {items,map}=await loadRaffles(); allMap=map;
    // “grid” como en Apps Script: mostrar una mezcla aleatoria de libres (hasta 400) si quieres
    const free=items.filter(i=>i.status==='libre');
    const today=todayKey(); const kR='dailyRaffles', kD='lastUpdate';
    let daily=JSON.parse(localStorage.getItem(kR)||'[]'); const last=localStorage.getItem(kD)||'';
    function pickRandom(arr, n){ const a=arr.slice(); for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a.slice(0,n); }
    if(last!==today || daily.length===0){ daily = pickRandom(free.map(f=>f.num),400); localStorage.setItem(kR,JSON.stringify(daily)); localStorage.setItem(kD,today); }
    else { daily = daily.filter(x=>free.some(f=>f.num===x)); localStorage.setItem(kR,JSON.stringify(daily)); }

    // pintar grid con “daily”
    const dailySet=new Set(daily);
    const toShow = items.filter(it=>dailySet.has(it.num));
    renderGrid(toShow);
  }catch(e){ showMsg("Error al sincronizar rifas",true); dbg(e); }
}
function rerenderSearch(){
  const s=document.getElementById("search");
  const raw=(s.value||"").replace(/\D/g,"").slice(0,4);
  if(s.value!==raw) s.value=raw;
  const layer=document.getElementById("layer"); layer.style.display="none"; layer.innerHTML="";
  if(raw.length===0) return;
  const padded=raw.padStart(4,"0");
  if(!(padded in allMap)){ showMsg("Verificando disponibilidad…"); return; }
  if(allMap[padded]==='libre') renderSearch([{num:padded}]); else showMsg("Boleta ocupada",true);
}

document.addEventListener("DOMContentLoaded",()=>{
  const s=document.getElementById("search");
  s.addEventListener("input",e=>{const v=e.target.value.replace(/\D/g,"").slice(0,4);if(e.target.value!==v)e.target.value=v;rerenderSearch()});
  document.getElementById("btnRnd").addEventListener("click",()=>{
    const libres=Object.keys(allMap).filter(k=>allMap[k]==='libre');
    if(!libres.length){showMsg("No hay boletas libres por ahora");return}
    const rnd=libres[Math.floor(Math.random()*libres.length)];
    s.value=parseInt(rnd,10).toString(); renderSearch([{num:rnd}]);
  });
  document.getElementById("ov").addEventListener("click",closeBox);
  loadConfig();
  syncAll();
  setInterval(syncAll, 5000);
});
  </script>
</body>
</html>
