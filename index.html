<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <title>Boletas de Rifa</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, interactive-widget=overlays-content">
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
  <style>
:root{
  --bg:#129a3a; --bg-deep:#0e7f30; --ink:#ffffff; --muted:#e5ffe8;
  --accent1:#00ffa9; --accent2:#3db7ff; --accent3:#ffb24d;
  --header-h:90px; --vv-top:0px; --extra-top:0px;
}

*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%} html{overflow-anchor:none}
body{
  margin:0; font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  color:var(--ink); background:var(--bg);
  -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  line-height:1.2;
  padding-top:calc(var(--header-h) + var(--vv-top) + var(--extra-top));
  overscroll-behavior-y:contain; touch-action:manipulation;
}

.top-veil{
  position:fixed; left:0; right:0; top:0;
  height:calc(var(--vv-top) + var(--extra-top) + var(--header-h) + 16px);
  z-index:25; pointer-events:none;
  background:linear-gradient(180deg,
    rgba(14,127,48,.94) 0%,
    rgba(14,127,48,.88) 40%,
    rgba(14,127,48,.72) 70%,
    rgba(14,127,48,0) 100%);
  -webkit-backdrop-filter:saturate(120%) blur(6px);
  backdrop-filter:saturate(120%) blur(6px);
  border-bottom:1px solid rgba(255,255,255,.12);
}

header{
  position:fixed; left:0; right:0; z-index:30;
  top:calc(var(--vv-top) + var(--extra-top));
  display:flex;align-items:center;gap:10px;flex-wrap:wrap;
  padding:10px 14px; min-height:90px;
  background:linear-gradient(0deg,rgba(0,0,0,.18),rgba(0,0,0,.18)), var(--bg-deep);
  border-bottom:1px solid rgba(255,255,255,.12);
  box-shadow:0 10px 26px rgba(0,0,0,.35);
}
/* FIX encabezado en móvil */
header{ top:0 !important; transform:translateZ(0); -webkit-transform:translateZ(0); backface-visibility:hidden; contain:paint; }

.brand{display:flex;align-items:center;gap:12px}
.brand img{
  height:56px;width:56px;object-fit:cover;border-radius:50%;
  border:2px solid rgba(255,255,255,.2);
  box-shadow:0 0 0 2px rgba(255,255,255,.18),0 0 22px rgba(0,0,0,.25);
}
.brand h1{
  margin:0;font-weight:900;font-size:clamp(18px,3.2vw,24px);letter-spacing:.5px;
  background:linear-gradient(90deg,#fff,var(--accent2) 50%,var(--accent1) 90%);
  -webkit-background-clip:text;background-clip:text;color:transparent;
}

.search-bar{
  flex:1 1 320px;
  height:56px;
  border-radius:16px; border:1px solid rgba(255,255,255,.22);
  padding:0 14px; font-size:20px; line-height:56px;
  outline:none; background:#0f3c1e; color:#f6fff7;
  box-shadow:inset 0 0 0 1px rgba(255,255,255,.15),0 8px 20px rgba(0,0,0,.25);
  touch-action:manipulation; caret-color:#ffffff;
  -webkit-appearance:none; appearance:none; transform:translateZ(0);
  scroll-margin-top:14vh;
}
.search-bar::placeholder{color:rgba(235,255,240,.8)}
.search-bar:focus{box-shadow:inset 0 0 0 2px var(--accent2),0 0 16px rgba(61,183,255,.45)}

.random-button{
  height:56px; border-radius:16px;
  padding:0 16px; font-weight:900; letter-spacing:.5px;
  border:none; cursor:pointer; color:#062017;
  background:linear-gradient(90deg,var(--accent1),#a9ffdf);
}

.contact-info{display:flex;flex-direction:row;align-items:center;gap:10px;margin-left:auto}
.contact-info p{margin:0;font-size:12px;color:var(--muted);font-weight:800;letter-spacing:.2px}

.search-result{
  position:fixed;
  top:calc(var(--vv-top) + var(--extra-top) + var(--header-h) + 12px);
  left:50%;
  transform:translateX(-50%);
  z-index:55;
  display:none;
  width:min(92vw,720px);
  pointer-events:auto;
  display:flex;flex-wrap:wrap;justify-content:center;gap:12px;
}

body.search-has-text header{ z-index:200; }
body.search-has-text #raffles{
  content-visibility:hidden;
  contain-intrinsic-size:1000px 1600px;
}
body.search-has-text *{ transition:none !important; }

#raffles{
  display:flex;flex-wrap:wrap;justify-content:center;gap:12px;
  margin:16px auto 28px;max-width:1240px;padding:0 10px 20vh;
}

.raffle{
  --size:clamp(92px,26vw,124px);
  width:var(--size);height:calc(var(--size) + 16px);
  border-radius:16px;display:flex;align-items:center;justify-content:center;
  position:relative;font-weight:900;color:#fff;
  background:
    radial-gradient(circle at 50% 28%, rgba(255,255,255,.10) 0 18%, transparent 19%),
    radial-gradient(circle at 37% 42%, rgba(255,255,255,.10) 0 18%, transparent 19%),
    radial-gradient(circle at 63% 42%, rgba(255,255,255,.10) 0 18%, transparent 19%),
    linear-gradient(145deg, transparent 0 62%, rgba(255,255,255,.10) 63%, transparent 64%),
    linear-gradient(160deg,#0b2b15,#0a2412 60%) ;
  box-shadow:inset 0 0 0 1px rgba(255,255,255,.10),0 10px 26px rgba(0,0,0,.35);
  outline:none;cursor:pointer;border:none;transform:translateZ(0);
}
.raffle span{
  font-size:clamp(38px,8.5vw,48px);line-height:1;
  text-shadow:0 2px 10px rgba(0,0,0,.45),0 0 18px rgba(255,255,255,.18);
}
.raffle::before{
  content:"";position:absolute;inset:-1px;border-radius:inherit;padding:6px;
  background:conic-gradient(from 180deg at 50% 50%,var(--accent1),var(--accent2),var(--accent3),var(--accent1));
  -webkit-mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);
  -webkit-mask-composite:xor;mask-composite:exclude;opacity:.95;
}
.raffle::after{
  content:"";position:absolute;inset:2px;border-radius:14px;
  background:radial-gradient(60% 60% at 50% 45%, rgba(255,255,255,.08), transparent 70%);
  z-index:0;
}

.large-raffle{--size:clamp(160px,52vw,200px);width:var(--size);height:calc(var(--size) + 18px)}
.large-raffle span{font-size:clamp(50px,12vw,70px)}

.message{
  padding:14px 16px;background:rgba(255,255,255,.12);color:#fff;border:1px solid rgba(255,255,255,.45);
  border-radius:14px;width:min(92vw,420px);text-align:center;
  font-size:clamp(16px,4.8vw,22px);font-weight:900;display:none;
  position:fixed;top:calc(var(--vv-top) + var(--extra-top) + var(--header-h) + 10px);left:50%;transform:translateX(-50%);
  z-index:60;box-shadow:0 12px 30px rgba(0,0,0,.35);
}
.message.error{
  background:linear-gradient(0deg,#ff3b30,#ff3b30) !important;
  border-color:#ffd0d0 !important;
  color:#ffffff !important;
}
.loading-message{
  position:fixed;top:44%;left:50%;transform:translate(-50%,-50%);
  background:#0f3c1e;color:#eaffea;border:1px solid rgba(255,255,255,.35);
  border-radius:14px;padding:16px 18px;text-align:center;font-size:clamp(18px,5vw,24px);
  display:none;box-shadow:0 12px 30px rgba(0,0,0,.35);z-index:40;
}

/* Overlay + Modal */
.ov{
  position:fixed; inset:0;
  background:rgba(0,0,0,.4);
  backdrop-filter:saturate(120%) blur(2px);
  z-index: 9000;
  display:none;
  align-items:center;
  justify-content:center;
}
.ov.show{ display:flex; }
.box{
  display:block;
  min-width:min(92vw,520px);
  max-width:92vw;
  background:#0f3c1e; color:#fff;
  border-radius:20px;
  border:1px solid rgba(255,255,255,.18);
  box-shadow:0 20px 60px rgba(0,0,0,.55);
  padding:20px 18px; text-align:center;
}
.q{margin:0 0 10px 0;font-size:clamp(18px,5vw,22px);font-weight:900}
.actions{display:flex;gap:10px;justify-content:center}
.btn.ok{
  font-weight:900;border:none;border-radius:14px;padding:12px 18px;cursor:pointer;
  background:linear-gradient(90deg,var(--accent1),#a9ffdf);color:#062017;
}
.btn.no{
  font-weight:900;border:none;border-radius:14px;padding:12px 18px;cursor:pointer;
  background:linear-gradient(90deg,#ff6b6b,#ffd0d0);color:#1a0606;
}

/* Revelado del número tras el efecto */
.raffle.revealed span{
  animation:revealPop .9s cubic-bezier(.2,.8,.2,1);
}
@keyframes revealPop{
  0%{ transform:scale(.82); filter:brightness(1.4); text-shadow:0 0 26px rgba(255,255,255,.65),0 0 40px rgba(0,255,169,.35) }
  60%{ transform:scale(1.06) }
  100%{ transform:scale(1); filter:none }
}

@media(max-width:768px){
  header{gap:8px;padding:12px 10px}
  .contact-info{flex-direction:row;flex-wrap:wrap;justify-content:center}
  .search-bar{width:100%}
  .random-button{width:100%}
  #raffles{gap:10px;margin-top:12px}
}
@media(prefers-reduced-motion:reduce){
  *,*::before,*::after{animation:none !important;transition:none !important}
}
  </style>
</head>
<body>
  <div class="top-veil" aria-hidden="true"></div>

  <header>
    <div class="brand">
      <img id="logoImg" src="" alt="Logo" referrerpolicy="no-referrer">
      <h1 id="houseName">Rifas</h1>
    </div>

    <input id="search" class="search-bar" type="tel" inputmode="numeric" pattern="[0-9]*" maxlength="4"
      enterkeyhint="search" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"
      placeholder="Buscar # de boleta…">
    <button class="random-button" id="randomButton"># ALEATORIO</button>

    <div class="contact-info">
      <p id="phone"></p>
      <p id="address"></p>
    </div>
  </header>

  <div id="searchResult" class="search-result"></div>
  <div id="raffles"></div>

  <!-- Overlay + Modal -->
  <div id="ov" class="ov" aria-hidden="true">
    <div id="box" class="box" role="dialog" aria-modal="true">
      <p id="q" class="q"></p>
      <div class="actions">
        <button id="yes" class="btn ok" type="button">Sí</button>
        <button id="no" class="btn no" type="button">No</button>
      </div>
    </div>
  </div>

  <!-- Mensajes -->
  <div id="message" class="message">Boleta ocupada</div>
  <div id="loadingMessage" class="loading-message">Buscando número aleatorio...</div>

  <script>
/*** ======= CONFIG ======= ***/
const KEY = '1MyOkJrGpeY1ZXQVFq_srndALEh6Nzzir8sFSfu-0EVM';
const GID_RAFFLES = '1661037065';
const GID_CONFIG  = '856149436';
const PROXY = 'https://csv-proxy.jeisendigital.workers.dev/?u=';

/*** ======= CSV helpers ======= ***/
const csvUrls = (gid) => {
  const ts = Date.now();
  return [
    `https://docs.google.com/spreadsheets/d/${KEY}/export?format=csv&gid=${gid}&_=${ts}`,
    `https://docs.google.com/spreadsheets/d/${KEY}/gviz/tq?tqx=out:csv&gid=${gid}&_=${ts}`,
  ];
};
const fetchText = async (url) => {
  const res = await fetch(PROXY + encodeURIComponent(url), {cache:'no-store', credentials:'omit'});
  if(!res.ok) throw new Error('HTTP '+res.status);
  return res.text();
};
async function fetchCsvAny(gid){
  const urls = csvUrls(gid);
  let lastErr = null, txt = '';
  for (const u of urls){
    try{ txt = await fetchText(u); if (txt && !txt.trimStart().startsWith('<')) return txt; } 
    catch(e){ lastErr = e; }
  }
  if (txt) return txt;
  throw lastErr || new Error('No se pudo obtener CSV');
}

/*** ======= Estado ======= ***/
let ALL = {};
let DAILY = [];
let SEARCH_INPUT = null;
let GRID_TIMER = null;
let MAP_TIMER = null;
let MODAL_OPEN = false;
let DAY_MARK = null;

/*** ======= Utils ======= */
const pad4 = n => String(n).replace(/\D/g,'').slice(0,4).padStart(4,'0');
const todayKey = () => new Date().toISOString().slice(0,10);
function randInt(maxExclusive){
  if (window.crypto && window.crypto.getRandomValues){
    const b = new Uint32Array(1);
    window.crypto.getRandomValues(b);
    return b[0] % maxExclusive;
  }
  return Math.floor(Math.random()*maxExclusive);
}
function msg(text, error=false){
  const el = document.getElementById('message');
  if (!el) return;
  el.textContent = text || '';
  el.classList.toggle('error', !!error);
  el.style.display = 'block';
  clearTimeout(msg._t);
  msg._t = setTimeout(()=>{ el.style.display = 'none'; }, error ? 2600 : 1400);
}
function hideMsg(){
  const el = document.getElementById('message');
  if (!el) return;
  clearTimeout(msg._t);
  el.style.display = 'none';
}
function parseCSV(text){
  if (text.trimStart().startsWith('<')) return [];
  const rows = [];
  let i=0, cur='', inQ=false;
  const push = ()=>{ rows[rows.length-1].push(cur); cur=''; };
  rows.push([]);
  while (i<text.length){
    const c=text[i];
    if (inQ){
      if (c === '"'){
        if (text[i+1] === '"'){ cur+='"'; i++; }
        else inQ=false;
      } else cur+=c;
    }else{
      if (c === '"'){ inQ=true; }
      else if (c === ','){ push(); }
      else if (c === '\n'){ push(); rows.push([]); }
      else if (c === '\r'){ }
      else cur+=c;
    }
    i++;
  }
  push();
  return rows.filter(r => r.some(x=>String(x).trim()!=='')); 
}
function makeBaseMap(){
  const map = {};
  for (let i=0;i<10000;i++){
    map[String(i).padStart(4,'0')] = 'ocupado';
  }
  return map;
}
function normStatusAB(s){
  const t = String(s ?? '').trim().toLowerCase();
  if (t === 'libre') return 'libre';
  return 'ocupado';
}
function extractColombiaDigits(raw){
  const chunks = (String(raw||'').match(/\d+/g) || []);
  let d = chunks.join('');
  d = d.replace(/^00/, '');
  const m = d.match(/57(3\d{9})/);
  if (m) return '57' + m[1];
  const m2 = d.match(/(?:^|[^0-9])(3\d{9})(?:[^0-9]|$)/);
  if (m2) return '57' + m2[1];
  const m3 = d.match(/0(3\d{9})/);
  if (m3) return '57' + m3[1];
  if (d.startsWith('57') && d.length >= 12) return d.slice(0, 12);
  return null;
}

/*** ======= UI ======= */
function confirmNum(n){
  const ov  = document.getElementById("ov");
  const box = document.getElementById("box");
  const yes = document.getElementById("yes");
  const no  = document.getElementById("no");
  const q   = document.getElementById("q");
  if(!ov || !box || !yes || !no || !q){ return; }
  MODAL_OPEN = true;
  q.textContent = "¿Quieres separar este número? " + n;
  box.style.display = "block";
  ov.classList.add("show");
  ov.setAttribute("aria-hidden","false");
  yes.onclick = (e)=>{ e.preventDefault(); e.stopPropagation(); closeBox(); openWA(n); };
  no.onclick  = (e)=>{ e.preventDefault(); e.stopPropagation(); closeBox(); };
  ov.onclick  = ()=> closeBox();
  box.onclick = (e)=> e.stopPropagation();
  setTimeout(()=>{ try{ yes.focus(); }catch(_){} }, 0);
}
function closeBox(){
  const ov  = document.getElementById("ov");
  const box = document.getElementById("box");
  MODAL_OPEN = false;
  if(ov){ ov.classList.remove("show"); ov.setAttribute("aria-hidden","true"); }
  if(box){ box.style.display = "block"; }
}
function openWA(number){
  const tel = window.__CONFIG_PHONE_DIGITS || '573206413635';
  const message = "Hola, estoy interesado en separar este número: " + number;
  const url = "https://wa.me/" + tel + "?text=" + encodeURIComponent(message);
  const w = window.open(url, '_blank'); if (!w){ location.href = url; }
}
function makeTile(num, large){
  const el = document.createElement('div');
  el.className = 'raffle' + (large ? ' large-raffle' : '');
  el.innerHTML = `<span>${num}</span>`;
  el.addEventListener('click', ()=> onTileTap(el, num), {passive:true});
  el.addEventListener('pointerdown', ()=>{}, {passive:true});
  return el;
}
function renderGrid(){
  const wrap = document.getElementById('raffles');
  if (!wrap) return;
  if (document.body.classList.contains('search-has-text') || MODAL_OPEN) return;
  wrap.innerHTML = '';
  DAILY.forEach(n => wrap.appendChild(makeTile(n, false)));
}
function renderSearchOne(num){
  const layer = document.getElementById('searchResult');
  layer.style.display = 'none';
  layer.innerHTML = '';
  if (!num) return;
  const t = makeTile(num, true);
  layer.appendChild(t);
  layer.style.display = 'flex';
  requestAnimationFrame(()=> t.classList.add('revealed'));
}
function clearSearchLayer(){
  const layer = document.getElementById('searchResult');
  layer.style.display = 'none';
  layer.innerHTML = '';
}

/*** ======= Config ======= */
async function loadConfig(){
  try{
    const txt = await fetchCsvAny(GID_CONFIG);
    const rows = parseCSV(txt);
    if(rows.length < 2) return;
    const head = rows[0]; const data = rows[1];
    const hIdx = (name) => head.findIndex(h => String(h).trim().toLowerCase() === name.toLowerCase());

    const name = data[hIdx('Nombre_APP')] || data[hIdx('Nombre_De_La_Rifa')] || 'Rifas';
    const phoneRaw = data[hIdx('Telefonos')] || '';
    const address = data[hIdx('Direccion')] || '';
    const logo = data[hIdx('Logo')] || '';

    document.getElementById('houseName').textContent = String(name || '').trim();
    document.getElementById('phone').textContent = phoneRaw ? ('Tel: ' + phoneRaw) : '';
    document.getElementById('address').textContent = address ? ('Dir: ' + address) : '';
    document.getElementById('logoImg').src = String(logo || '').trim();

    window.__CONFIG_PHONE = phoneRaw || '';
    window.__CONFIG_PHONE_DIGITS = extractColombiaDigits(phoneRaw) || '573206413635';
  }catch(e){ console.warn('Config error', e); }
}

/*** ======= Persistencia/diario ======= */
function persistDaily(){
  const key = 'daily_' + todayKey();
  try { localStorage.setItem(key, JSON.stringify(DAILY || [])); } catch(_){}
}
function loadDailyFromCache(){
  const key = 'daily_' + todayKey();
  try{
    const cached = JSON.parse(localStorage.getItem(key) || '[]');
    if (Array.isArray(cached) && cached.length){
      DAILY = cached.filter(n => ALL[n] === 'libre');
      persistDaily();
      return DAILY.length > 0;
    }
  }catch(_){}
  return false;
}
function pickDaily(force=false){
  if (!force && loadDailyFromCache()) return;
  const libres = Object.keys(ALL || {}).filter(k => ALL[k] === 'libre');
  for (let i=libres.length-1;i>0;i--){
    const j = randInt(i+1);
    [libres[i],libres[j]] = [libres[j],libres[i]];
  }
  DAILY = libres.slice(0, 400);
  persistDaily();
}

/*** ======= Sync ======= */
async function syncMap(){
  try{
    const txt = await fetchCsvAny(GID_RAFFLES);
    const rows = parseCSV(txt);
    if(rows.length < 2){ console.warn('No hay filas'); return; }
    const map = makeBaseMap();
    for (let i=1;i<rows.length;i++){
      const r = rows[i] || [];
      const a = (r[0] ?? '').toString().trim();
      const b = (r[1] ?? '').toString().trim();
      if (!a) continue;
      let digits = a.replace(/\D/g,'');
      if (!digits) continue;
      if (digits.length > 4) digits = digits.slice(0,4);
      const num = digits.padStart(4,'0');
      map[num] = normStatusAB(b);
    }
    ALL = map;

    const before = DAILY.length;
    DAILY = (DAILY || []).filter(n => ALL[n] === 'libre');
    if (DAILY.length !== before) persistDaily();
  }catch(e){ console.warn('syncMap error', e); }
}

/*** ======= Búsqueda ======= */
async function rerenderSearch(){
  const layer = document.getElementById('searchResult');
  hideMsg();
  const raw = (SEARCH_INPUT.value || '').replace(/\D/g,'').slice(0,4);
  if (SEARCH_INPUT.value !== raw) SEARCH_INPUT.value = raw;
  layer.style.display = 'none';
  layer.innerHTML = '';
  if (raw.length === 0){
    document.body.classList.remove('search-has-text');
    return;
  }
  document.body.classList.add('search-has-text');
  if (!ALL || !Object.keys(ALL).length){
    await syncMap();
    if (!ALL || !Object.keys(ALL).length){ msg('Sin conexión o datos.', true); return; }
  }
  const padded = pad4(raw);
  const st = ALL[padded] || 'ocupado';
  if (st === 'libre'){
    hideMsg();
    renderSearchOne(padded);
  }else{
    clearSearchLayer();
    msg('Boleta ocupada', true);
  }
}

/* ========= EFECTO NUEVO: AGUA REAL + CHISPAS ========= */
function overlayCanvas(container){
  if (!container) return null;
  const cs = getComputedStyle(container);
  if (cs.position === 'static') container.style.position = 'relative';
  const rect = container.getBoundingClientRect();
  const dpr = Math.min(window.devicePixelRatio || 1, 2);
  const c = document.createElement('canvas');
  const w = Math.max(1, Math.floor(rect.width * dpr));
  const h = Math.max(1, Math.floor(rect.height * dpr));
  c.width = w; c.height = h;
  c.style.width = rect.width + 'px';
  c.style.height = rect.height + 'px';
  c.style.position = 'absolute';
  c.style.inset = '0';
  c.style.pointerEvents = 'none';
  c.style.zIndex = '5';
  container.appendChild(c);
  const ctx = c.getContext('2d');
  return {c, ctx, dpr, w, h, cleanup:()=> c.remove()};
}
function animateMs(duration, draw){
  return new Promise(resolve=>{
    const start = performance.now();
    let last = start;
    let rafId = 0;
    function loop(t){
      const elapsed = t - start;
      const dt = Math.min(64, t - last) / 1000;
      last = t;
      const p = Math.min(1, elapsed / duration);
      draw(p, dt, elapsed);
      if (elapsed < duration) { rafId = requestAnimationFrame(loop); }
      else { cancelAnimationFrame(rafId); resolve(); }
    }
    rafId = requestAnimationFrame(loop);
  });
}
function easeOutCubic(x){ return 1 - Math.pow(1 - x, 3); }
function hexToRgba(hex, a){
  const h = hex.replace('#','');
  const r = parseInt(h.substring(0,2),16);
  const g = parseInt(h.substring(2,4),16);
  const b = parseInt(h.substring(4,6),16);
  return `rgba(${r},${g},${b},${a})`;
}

/* Ondas con cresta/luz y valle/sombra + oscurecimiento del tile + chispas */
function playWaterRipple(container, duration=2000, center){
  if (!container) return Promise.resolve();
  if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) return Promise.resolve();
  const oc = overlayCanvas(container);
  if (!oc) return Promise.resolve();
  const {ctx, w, h, dpr, cleanup} = oc;
  const cx = center?.x ?? (w/2), cy = center?.y ?? (h/2);

  // Chispas mágicas
  const sparkCols = ['#ffd44d','#00ffa9'];
  const SPN = Math.floor(24 * Math.min(1.6,(w*h)/60000));
  const sparks = [];
  for (let i=0;i<SPN;i++){
    const ang = Math.random()*Math.PI*2;
    const sp = (120 + Math.random()*180) * dpr;
    sparks.push({
      x:cx, y:cy,
      vx:Math.cos(ang)*sp, vy:Math.sin(ang)*sp - 80*dpr,
      r:(1 + Math.random()*2) * dpr,
      life:0, max:0.7 + Math.random()*0.6,
      col:sparkCols[(Math.random()*sparkCols.length)|0]
    });
  }

  // Config de ondas
  const maxR = Math.hypot(w,h) * 0.6;
  const rings = [
    {delay:0},
    {delay:140},
    {delay:290},
    {delay:450}
  ];

  // Dibuja un anillo con gradiente de cresta/valle
  function drawRing(R, thickness, alpha){
    if (R<=0 || thickness<=0 || alpha<=0) return;
    const inner = Math.max(0.0001, R - thickness);
    const outer = R + thickness;
    const g = ctx.createRadialGradient(cx, cy, inner, cx, cy, outer);
    // valle (ligera sombra), cresta brillante, color neón, desvanecer
    g.addColorStop(0.00, 'rgba(0,0,0,0)');
    g.addColorStop(0.20, `rgba(0,0,0,${0.25*alpha})`);
    g.addColorStop(0.46, `rgba(255,255,255,${0.55*alpha})`);
    g.addColorStop(0.64, hexToRgba('#00ffa9', 0.65*alpha));
    g.addColorStop(0.84, hexToRgba('#3db7ff', 0.35*alpha));
    g.addColorStop(1.00, 'rgba(0,0,0,0)');
    ctx.fillStyle = g;
    ctx.fillRect(0,0,w,h);

    // Destello especular parcial para realismo
    ctx.save();
    ctx.lineWidth = Math.max(0.8, 3*dpr*(1 - R/maxR));
    ctx.strokeStyle = `rgba(255,255,255,${0.35*alpha})`;
    const arcLen = Math.PI * 0.55;
    const rot = -Math.PI/6;
    ctx.beginPath();
    ctx.arc(cx, cy, R, rot, rot + arcLen);
    ctx.stroke();
    ctx.restore();
  }

  ctx.globalCompositeOperation = 'source-over';
  return animateMs(Math.min(2000, duration), (p, dt, ms)=>{
    ctx.clearRect(0,0,w,h);

    // Oscurecer el cuadro según progreso (sensación de profundidad)
    const dimA = 0.28 * easeOutCubic(Math.min(1, ms/260));
    ctx.fillStyle = `rgba(0,0,0,${dimA})`;
    ctx.fillRect(0,0,w,h);

    // Ondas (varias con delays)
    for (let i=0;i<rings.length;i++){
      const t = ms - rings[i].delay;
      if (t < 0) continue;
      const pr = Math.min(1, t / (duration - rings[i].delay + 1));
      const amp = (1 - pr) * 0.95;               // amplitud decae
      const R = pr * maxR;
      const thick = Math.max(1.5*dpr, 10*dpr*(1 - pr)); // grosor se afina
      drawRing(R, thick, amp);
    }

    // Chispas doradas + verde neón
    ctx.globalCompositeOperation = 'lighter';
    for (const s of sparks){
      s.life += dt;
      s.vx *= (1 - 0.55*dt);
      s.vy *= (1 - 0.55*dt);
      s.vy += 220*dt*dpr*0.25; // pseudo-gravedad
      s.x += s.vx*dt; s.y += s.vy*dt;
      const a = Math.max(0, 1 - (s.life / s.max));
      if (a <= 0) continue;
      ctx.beginPath();
      ctx.fillStyle = hexToRgba(s.col, 0.9*a);
      ctx.arc(s.x, s.y, s.r, 0, Math.PI*2);
      ctx.fill();
      if (Math.random()<0.08){ // highlight puntual
        ctx.beginPath();
        ctx.fillStyle = `rgba(255,255,255,${0.6*a})`;
        ctx.arc(s.x, s.y, s.r*0.5, 0, Math.PI*2);
        ctx.fill();
      }
    }
    ctx.globalCompositeOperation = 'source-over';
  }).then(cleanup);
}

/* Tap de boleta: NUEVO efecto agua + chispas (2s) y luego confirmar */
function onTileTap(el, num){
  if (!el || el.dataset.busy === '1') return;
  el.dataset.busy = '1';
  hideMsg();
  const rect = el.getBoundingClientRect();
  const dpr = Math.min(window.devicePixelRatio||1, 2);
  const center = { x: (rect.width*dpr)/2, y: (rect.height*dpr)/2 };
  playWaterRipple(el, 2000, center).then(()=>{
    el.dataset.busy = '';
    confirmNum(num);
  }).catch(()=>{
    el.dataset.busy = '';
    confirmNum(num);
  });
}

/*** ======= INIT ======= */
document.addEventListener('DOMContentLoaded', async ()=>{
  function applyViewportOffset(){
    var top = 0;
    if (window.visualViewport){
      top = Math.max(0, Math.round(window.visualViewport.offsetTop || 0));
    }
    document.documentElement.style.setProperty('--vv-top', top + 'px');
    updateHeaderPadding();
  }
  function updateHeaderPadding(){
    var header = document.querySelector('header');
    if(!header) return;
    var h = Math.max(70, Math.round(header.getBoundingClientRect().height));
    document.documentElement.style.setProperty('--header-h', h + 'px');
  }

  SEARCH_INPUT = document.getElementById('search');
  function instantFocus(e){
    if (document.activeElement !== SEARCH_INPUT) {
      e.preventDefault();
      SEARCH_INPUT.focus({preventScroll:true});
      setTimeout(()=>{
        try{ 
          var len = SEARCH_INPUT.value.length;
          SEARCH_INPUT.setSelectionRange(len, len);
        }catch(_){}
      }, 0);
    }
  }
  SEARCH_INPUT.addEventListener('pointerdown', instantFocus, {passive:false});
  SEARCH_INPUT.addEventListener('touchstart', instantFocus, {passive:false});
  SEARCH_INPUT.addEventListener('click', function(){
    if (document.activeElement !== SEARCH_INPUT) SEARCH_INPUT.focus({preventScroll:true});
  }, {passive:true});
  SEARCH_INPUT.addEventListener('input', () => { rerenderSearch(); });
  SEARCH_INPUT.addEventListener('blur', function(){
    if (!MODAL_OPEN && SEARCH_INPUT.value.trim().length === 0){
      document.body.classList.remove('search-has-text');
      clearSearchLayer();
    }
  });

  // Botón ALEATORIO con efecto mágico existente
  const randomBtn = document.getElementById('randomButton');
  randomBtn.addEventListener('click', async function() {
    if (randomBtn.dataset.busy === '1') return;
    randomBtn.dataset.busy = '1';

    hideMsg();
    const layer = document.getElementById('searchResult');
    layer.style.display = 'none';
    layer.innerHTML = '';

    if (!ALL || !Object.keys(ALL).length){ await syncMap(); }

    let chosen = null;
    const libres = Object.keys(ALL || {}).filter(k => ALL[k] === 'libre');
    if (libres.length){
      chosen = libres[randInt(libres.length)];
    }else{
      chosen = String(randInt(10000)).padStart(4,'0');
    }

    document.body.classList.add('search-has-text');

    // placeholder para el efecto sorpresa (ya existente de tu versión previa)
    const placeholder = document.createElement('div');
    placeholder.className = 'raffle large-raffle';
    layer.appendChild(placeholder);
    layer.style.display = 'flex';

    // Reusa el efecto mágico previo (ráfaga) para el aleatorio:
    await (async function playMagicBurst(container, duration=1800){
      if (!container) return;
      if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) return;
      const oc = overlayCanvas(container); if (!oc) return;
      const {ctx, w, h, dpr, cleanup} = oc;
      const cx = w/2, cy = h/2;
      const colors = ['#ffd44d','#00ffa9','#3db7ff','#ffffff'];
      const N = Math.floor(Math.min(140, 80 + (w*h)/40000));
      const parts = [];
      for (let i=0;i<N;i++){
        const ang = Math.random()*Math.PI*2;
        const sp = (80 + Math.random()*220) * dpr;
        const r = 1.6 + Math.random()*2.6;
        parts.push({x:cx,y:cy,vx:Math.cos(ang)*sp,vy:Math.sin(ang)*sp,life:0,max:0.9+Math.random()*0.7,r:r*dpr,col:colors[(Math.random()*colors.length)|0]});
      }
      ctx.globalCompositeOperation = 'lighter';
      await animateMs(Math.min(3000, duration), (p, dt)=>{
        ctx.clearRect(0,0,w,h);
        const glow = ctx.createRadialGradient(cx,cy,0,cx,cy,Math.max(w,h)*0.45);
        glow.addColorStop(0, 'rgba(255,255,255,0.18)');
        glow.addColorStop(0.35, 'rgba(0,255,169,0.12)');
        glow.addColorStop(1, 'rgba(0,0,0,0)');
        ctx.fillStyle = glow;
        ctx.beginPath(); ctx.arc(cx,cy,Math.max(w,h)*0.45,0,Math.PI*2); ctx.fill();
        const ringR = (Math.max(w,h)*0.55) * Math.sin(p*Math.PI);
        const alphaRing = (1 - p) * 0.9;
        ctx.lineWidth = Math.max(1, 6*dpr*(1-p));
        ctx.strokeStyle = `rgba(255,212,77,${alphaRing})`;
        ctx.beginPath(); ctx.arc(cx,cy,Math.max(0,ringR*0.65),0,Math.PI*2); ctx.stroke();
        ctx.strokeStyle = `rgba(0,255,169,${alphaRing*0.85})`;
        ctx.beginPath(); ctx.arc(cx,cy,Math.max(0,ringR*0.45),0,Math.PI*2); ctx.stroke();
        for (const pt of parts){
          pt.life += dt;
          pt.vx *= (1 - 0.8*dt);
          pt.vy *= (1 - 0.8*dt);
          pt.vy += 260*dt*dpr*0.25;
          pt.x += pt.vx*dt;
          pt.y += pt.vy*dt;
          const alpha = Math.max(0, 1 - (pt.life/pt.max));
          if (alpha <= 0) continue;
          ctx.beginPath();
          ctx.fillStyle = hexToRgba(pt.col, alpha);
          ctx.arc(pt.x, pt.y, pt.r, 0, Math.PI*2);
          ctx.fill();
          if (Math.random()<0.08){
            ctx.beginPath();
            ctx.fillStyle = 'rgba(255,255,255,'+(alpha*0.8)+')';
            ctx.arc(pt.x, pt.y, pt.r*0.5, 0, Math.PI*2);
            ctx.fill();
          }
        }
      });
      cleanup();
    })(placeholder, 1800);

    const st = ALL[chosen] || 'ocupado';
    SEARCH_INPUT.value = String(parseInt(chosen, 10));
    if (st === 'libre'){
      renderSearchOne(chosen);
    }else{
      clearSearchLayer();
      msg('Boleta ocupada', true);
    }
    randomBtn.dataset.busy = '';
  }, {passive:true});

  // Layout
  function updateHeaderPadding(){ var header = document.querySelector('header'); if(!header) return; var h = Math.max(70, Math.round(header.getBoundingClientRect().height)); document.documentElement.style.setProperty('--header-h', h + 'px'); }
  function applyViewportOffset(){ var top = 0; if (window.visualViewport){ top = Math.max(0, Math.round(window.visualViewport.offsetTop || 0)); } document.documentElement.style.setProperty('--vv-top', top + 'px'); updateHeaderPadding(); }
  updateHeaderPadding();
  applyViewportOffset();
  if (window.visualViewport){
    visualViewport.addEventListener('resize', ()=> requestAnimationFrame(applyViewportOffset));
    visualViewport.addEventListener('scroll', ()=> requestAnimationFrame(applyViewportOffset));
  }
  window.addEventListener('resize', ()=> requestAnimationFrame(applyViewportOffset), {passive:true});

  // Carga inicial
  DAY_MARK = todayKey();
  await loadConfig();
  await syncMap();
  pickDaily(true);
  renderGrid();

  // Timers
  GRID_TIMER = setInterval(()=> renderGrid(), 5000);
  MAP_TIMER  = setInterval(async ()=>{
    const nowKey = todayKey();
    if (nowKey !== DAY_MARK){
      DAY_MARK = nowKey;
      await syncMap();
      DAILY = [];
      pickDaily(true);
      renderGrid();
      return;
    }
    const before = DAILY.length;
    await syncMap();
    if (DAILY.length !== before){
      renderGrid();
    }
  }, 5000);
});
  </script>
</body>
</html>
